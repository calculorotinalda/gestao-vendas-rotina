{% extends "base.html" %}

{% block title %}Análises - GestVendas{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-analytics me-2"></i>Análises Avançadas</h2>
    <div class="btn-group">
        <button type="button" class="btn btn-outline-primary btn-sm" id="refresh-data">
            <i class="fas fa-sync-alt me-1"></i>Atualizar
        </button>
        <select class="form-select form-select-sm" id="period-filter" style="width: auto;">
            <option value="7">Últimos 7 dias</option>
            <option value="30" selected>Últimos 30 dias</option>
            <option value="90">Últimos 90 dias</option>
            <option value="365">Último ano</option>
        </select>
    </div>
</div>

<!-- Key Performance Indicators -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6">
        <div class="stat-card">
            <div class="stat-icon bg-primary">
                <i class="fas fa-chart-line"></i>
            </div>
            <div class="stat-info">
                <h3 id="revenue-growth">{{ analytics.revenue_growth }}%</h3>
                <p>Crescimento Receitas</p>
                <small class="text-muted">vs período anterior</small>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="stat-card">
            <div class="stat-icon bg-success">
                <i class="fas fa-coins"></i>
            </div>
            <div class="stat-info">
                <h3 id="profit-margin">{{ analytics.profit_margin }}%</h3>
                <p>Margem de Lucro</p>
                <small class="text-muted">média do período</small>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="stat-card">
            <div class="stat-icon bg-warning">
                <i class="fas fa-shopping-cart"></i>
            </div>
            <div class="stat-info">
                <h3 id="avg-order-value">{{ format_currency(analytics.avg_order_value) }}</h3>
                <p>Valor Médio Venda</p>
                <small class="text-muted">por transação</small>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="stat-card">
            <div class="stat-icon bg-info">
                <i class="fas fa-boxes"></i>
            </div>
            <div class="stat-info">
                <h3 id="inventory-turnover">{{ analytics.inventory_turnover }}x</h3>
                <p>Rotação Stock</p>
                <small class="text-muted">vezes por ano</small>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row 1 -->
<div class="row mb-4">
    <div class="col-xl-8">
        <div class="data-card">
            <div class="header">
                <h5><i class="fas fa-chart-area me-2"></i>Evolução de Vendas vs Compras</h5>
                <div class="chart-controls">
                    <button class="btn btn-sm btn-outline-secondary" onclick="toggleChartType('revenue-chart')">
                        <i class="fas fa-exchange-alt"></i>
                    </button>
                </div>
            </div>
            <div style="height: 400px;">
                <canvas id="revenue-chart"></canvas>
            </div>
        </div>
    </div>
    <div class="col-xl-4">
        <div class="data-card">
            <div class="header">
                <h5><i class="fas fa-chart-pie me-2"></i>Vendas por Categoria</h5>
            </div>
            <div style="height: 400px;">
                <canvas id="category-chart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row 2 -->
<div class="row mb-4">
    <div class="col-xl-6">
        <div class="data-card">
            <div class="header">
                <h5><i class="fas fa-chart-bar me-2"></i>Top Produtos por Vendas</h5>
            </div>
            <div style="height: 350px;">
                <canvas id="products-chart"></canvas>
            </div>
        </div>
    </div>
    <div class="col-xl-6">
        <div class="data-card">
            <div class="header">
                <h5><i class="fas fa-chart-line me-2"></i>Análise de Margem de Lucro</h5>
            </div>
            <div style="height: 350px;">
                <canvas id="margin-chart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Tables Row -->
<div class="row mb-4">
    <div class="col-xl-6">
        <div class="data-card">
            <div class="header">
                <h5><i class="fas fa-trophy me-2"></i>Top Clientes</h5>
                <span class="badge bg-primary">{{ analytics.top_customers|length }}</span>
            </div>
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Cliente</th>
                            <th>Vendas</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for customer in analytics.top_customers %}
                        <tr>
                            <td>{{ customer.name }}</td>
                            <td><span class="badge bg-info">{{ customer.sales_count }}</span></td>
                            <td><strong>{{ format_currency(customer.total_amount) }}</strong></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="col-xl-6">
        <div class="data-card">
            <div class="header">
                <h5><i class="fas fa-exclamation-triangle me-2"></i>Alertas de Stock</h5>
                <span class="badge bg-warning">{{ analytics.stock_alerts|length }}</span>
            </div>
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Produto</th>
                            <th>Stock Atual</th>
                            <th>Mínimo</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for product in analytics.stock_alerts %}
                        <tr>
                            <td>{{ product.name }}</td>
                            <td>{{ product.stock_quantity }}</td>
                            <td>{{ product.min_stock }}</td>
                            <td>
                                <span class="badge bg-{{ 'danger' if product.stock_quantity == 0 else 'warning' }}">
                                    {{ 'Sem Stock' if product.stock_quantity == 0 else 'Stock Baixo' }}
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Financial Analysis -->
<div class="row">
    <div class="col-12">
        <div class="data-card">
            <div class="header">
                <h5><i class="fas fa-calculator me-2"></i>Análise Financeira Detalhada</h5>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary active" onclick="showFinancialView('summary')">Resumo</button>
                    <button class="btn btn-outline-primary" onclick="showFinancialView('monthly')">Mensal</button>
                    <button class="btn btn-outline-primary" onclick="showFinancialView('trends')">Tendências</button>
                </div>
            </div>
            
            <div id="financial-summary" class="financial-view">
                <div class="row">
                    <div class="col-md-3">
                        <div class="metric-box">
                            <label>Receitas Totais</label>
                            <h4 class="text-success">{{ format_currency(analytics.total_revenue) }}</h4>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-box">
                            <label>Custos Totais</label>
                            <h4 class="text-danger">{{ format_currency(analytics.total_costs) }}</h4>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-box">
                            <label>Lucro Bruto</label>
                            <h4 class="text-primary">{{ format_currency(analytics.gross_profit) }}</h4>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-box">
                            <label>ROI</label>
                            <h4 class="text-info">{{ analytics.roi }}%</h4>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="financial-monthly" class="financial-view" style="display: none;">
                <canvas id="monthly-financial-chart" height="100"></canvas>
            </div>
            
            <div id="financial-trends" class="financial-view" style="display: none;">
                <canvas id="trends-chart" height="100"></canvas>
            </div>
        </div>
    </div>
</div>

<script>
// Initialize charts
let revenueChart, categoryChart, productsChart, marginChart, monthlyChart, trendsChart;

document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();
    setupEventListeners();
});

function initializeCharts() {
    // Revenue vs Purchases Chart
    const revenueCtx = document.getElementById('revenue-chart').getContext('2d');
    revenueChart = new Chart(revenueCtx, {
        type: 'line',
        data: {
            labels: {{ analytics.revenue_labels|tojson }},
            datasets: [{
                label: 'Vendas',
                data: {{ analytics.revenue_data|tojson }},
                borderColor: '#28a745',
                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                tension: 0.4
            }, {
                label: 'Compras',
                data: {{ analytics.purchase_data|tojson }},
                borderColor: '#dc3545',
                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value.toLocaleString('pt-PT') + ' €';
                        }
                    }
                }
            }
        }
    });

    // Category Sales Chart
    const categoryCtx = document.getElementById('category-chart').getContext('2d');
    categoryChart = new Chart(categoryCtx, {
        type: 'doughnut',
        data: {
            labels: {{ analytics.category_labels|tojson }},
            datasets: [{
                data: {{ analytics.category_data|tojson }},
                backgroundColor: [
                    '#007bff', '#28a745', '#ffc107', '#dc3545', 
                    '#6f42c1', '#fd7e14', '#20c997', '#6c757d'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });

    // Top Products Chart
    const productsCtx = document.getElementById('products-chart').getContext('2d');
    productsChart = new Chart(productsCtx, {
        type: 'bar',
        data: {
            labels: {{ analytics.top_products_labels|tojson }},
            datasets: [{
                label: 'Vendas (€)',
                data: {{ analytics.top_products_data|tojson }},
                backgroundColor: '#007bff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });

    // Margin Analysis Chart
    const marginCtx = document.getElementById('margin-chart').getContext('2d');
    marginChart = new Chart(marginCtx, {
        type: 'scatter',
        data: {
            datasets: [{
                label: 'Produtos',
                data: {{ analytics.margin_analysis|tojson }},
                backgroundColor: '#28a745'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Volume de Vendas'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Margem de Lucro (%)'
                    }
                }
            }
        }
    });
}

function setupEventListeners() {
    // Period filter
    document.getElementById('period-filter').addEventListener('change', function() {
        refreshAnalytics(this.value);
    });

    // Refresh button
    document.getElementById('refresh-data').addEventListener('click', function() {
        const period = document.getElementById('period-filter').value;
        refreshAnalytics(period);
    });
}

function refreshAnalytics(period) {
    // Show loading state
    document.getElementById('refresh-data').innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Carregando...';
    
    // Simulate API call (replace with actual endpoint)
    fetch(`/analytics/data?period=${period}`)
        .then(response => response.json())
        .then(data => {
            updateCharts(data);
            updateKPIs(data);
        })
        .catch(error => {
            console.error('Error:', error);
        })
        .finally(() => {
            document.getElementById('refresh-data').innerHTML = '<i class="fas fa-sync-alt me-1"></i>Atualizar';
        });
}

function updateCharts(data) {
    // Update all charts with new data
    revenueChart.data.labels = data.revenue_labels;
    revenueChart.data.datasets[0].data = data.revenue_data;
    revenueChart.data.datasets[1].data = data.purchase_data;
    revenueChart.update();
    
    // Update other charts similarly...
}

function updateKPIs(data) {
    document.getElementById('revenue-growth').textContent = data.revenue_growth + '%';
    document.getElementById('profit-margin').textContent = data.profit_margin + '%';
    document.getElementById('avg-order-value').textContent = data.avg_order_value + ' €';
    document.getElementById('inventory-turnover').textContent = data.inventory_turnover + 'x';
}

function toggleChartType(chartId) {
    const chart = eval(chartId.replace('-', ''));
    chart.config.type = chart.config.type === 'line' ? 'bar' : 'line';
    chart.update();
}

function showFinancialView(view) {
    // Hide all views
    document.querySelectorAll('.financial-view').forEach(el => el.style.display = 'none');
    
    // Show selected view
    document.getElementById(`financial-${view}`).style.display = 'block';
    
    // Update active button
    document.querySelectorAll('.btn-group button').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
}
</script>

<style>
.stat-card {
    background: white;
    border-radius: 0.5rem;
    padding: 1.5rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    border: 1px solid #e9ecef;
    display: flex;
    align-items: center;
    gap: 1rem;
}

.stat-icon {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.5rem;
}

.stat-info h3 {
    margin: 0;
    font-size: 1.8rem;
    font-weight: bold;
}

.stat-info p {
    margin: 0.25rem 0 0 0;
    color: #6c757d;
    font-weight: 500;
}

.chart-controls {
    display: flex;
    gap: 0.5rem;
}

.metric-box {
    text-align: center;
    padding: 1rem;
    border: 1px solid #e9ecef;
    border-radius: 0.375rem;
    background: #f8f9fa;
}

.metric-box label {
    display: block;
    font-size: 0.875rem;
    color: #6c757d;
    margin-bottom: 0.5rem;
}

.metric-box h4 {
    margin: 0;
    font-size: 1.5rem;
    font-weight: bold;
}

.financial-view {
    padding: 1rem 0;
}
</style>
{% endblock %}