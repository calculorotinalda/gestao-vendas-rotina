{"file_contents":{"app.py":{"content":"import os\nimport logging\n\nfrom flask import Flask\nfrom flask_sqlalchemy import SQLAlchemy\nfrom sqlalchemy.orm import DeclarativeBase\nfrom werkzeug.middleware.proxy_fix import ProxyFix\n\n# Configure logging\nlogging.basicConfig(level=logging.DEBUG)\n\nclass Base(DeclarativeBase):\n    pass\n\ndb = SQLAlchemy(model_class=Base)\n\n# create the app\napp = Flask(__name__)\napp.secret_key = os.environ.get(\"SESSION_SECRET\", \"your-secret-key-here\")\napp.wsgi_app = ProxyFix(app.wsgi_app, x_proto=1, x_host=1)\n\n# configure the database\napp.config[\"SQLALCHEMY_DATABASE_URI\"] = os.environ.get(\"DATABASE_URL\", \"postgresql://localhost/gestvendas\")\napp.config[\"SQLALCHEMY_ENGINE_OPTIONS\"] = {\n    \"pool_recycle\": 300,\n    \"pool_pre_ping\": True,\n}\napp.config[\"SQLALCHEMY_TRACK_MODIFICATIONS\"] = False\n\n# initialize the app with the extension\ndb.init_app(app)\n\n# Try to initialize database tables when needed, not at startup\ndef init_database():\n    try:\n        with app.app_context():\n            import models  # noqa: F401\n            db.create_all()\n            return True\n    except Exception as e:\n        print(f\"Database initialization failed: {e}\")\n        return False\n\n# Import routes\nimport simple_routes  # noqa: F401\n# import routes  # noqa: F401  # Temporarily disabled due to conflicts\n","size_bytes":1280},"main.py":{"content":"from app import app\n\nif __name__ == '__main__':\n    app.run(host='0.0.0.0', port=5000, debug=True)\n","size_bytes":99},"models.py":{"content":"from datetime import datetime\nfrom app import db\nfrom werkzeug.security import generate_password_hash, check_password_hash\nfrom sqlalchemy import func\n\nclass User(db.Model):\n    __tablename__ = 'users'\n    \n    id = db.Column(db.Integer, primary_key=True)\n    username = db.Column(db.String(80), unique=True, nullable=False)\n    email = db.Column(db.String(120), unique=True, nullable=False)\n    password_hash = db.Column(db.String(256), nullable=False)\n    full_name = db.Column(db.String(200))\n    role = db.Column(db.String(50), default='user')\n    is_active = db.Column(db.Boolean, default=True)\n    confirmation_token = db.Column(db.String(100))\n    created_at = db.Column(db.DateTime, default=datetime.utcnow)\n    updated_at = db.Column(db.DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)\n\n    def set_password(self, password):\n        self.password_hash = generate_password_hash(password)\n\n    def check_password(self, password):\n        return check_password_hash(self.password_hash, password)\n\nclass Category(db.Model):\n    __tablename__ = 'categories'\n    \n    id = db.Column(db.Integer, primary_key=True)\n    name = db.Column(db.String(100), unique=True, nullable=False)\n    description = db.Column(db.Text)\n    is_active = db.Column(db.Boolean, default=True)\n    created_at = db.Column(db.DateTime, default=datetime.utcnow)\n    updated_at = db.Column(db.DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)\n    \n    # Relationships\n    products = db.relationship('Product', backref='category', lazy=True)\n\nclass Supplier(db.Model):\n    __tablename__ = 'suppliers'\n    \n    id = db.Column(db.Integer, primary_key=True)\n    name = db.Column(db.String(200), nullable=False)\n    contact_person = db.Column(db.String(100))\n    email = db.Column(db.String(120))\n    phone = db.Column(db.String(20))\n    address = db.Column(db.Text)\n    city = db.Column(db.String(100))\n    postal_code = db.Column(db.String(20))\n    country = db.Column(db.String(100), default='Portugal')\n    tax_number = db.Column(db.String(50))\n    is_active = db.Column(db.Boolean, default=True)\n    created_at = db.Column(db.DateTime, default=datetime.utcnow)\n    updated_at = db.Column(db.DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)\n    \n    # Relationships\n    products = db.relationship('Product', backref='supplier', lazy=True)\n    purchases = db.relationship('Purchase', backref='supplier', lazy=True)\n\nclass Customer(db.Model):\n    __tablename__ = 'customers'\n    \n    id = db.Column(db.Integer, primary_key=True)\n    name = db.Column(db.String(200), nullable=False)\n    email = db.Column(db.String(120))\n    phone = db.Column(db.String(20))\n    address = db.Column(db.Text)\n    city = db.Column(db.String(100))\n    postal_code = db.Column(db.String(20))\n    country = db.Column(db.String(100), default='Portugal')\n    tax_number = db.Column(db.String(50))\n    customer_type = db.Column(db.String(50), default='particular')  # particular, empresa\n    is_active = db.Column(db.Boolean, default=True)\n    created_at = db.Column(db.DateTime, default=datetime.utcnow)\n    updated_at = db.Column(db.DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)\n    \n    # Relationships\n    sales = db.relationship('Sale', backref='customer', lazy=True)\n\nclass Product(db.Model):\n    __tablename__ = 'products'\n    \n    id = db.Column(db.Integer, primary_key=True)\n    code = db.Column(db.String(50), unique=True, nullable=False)\n    name = db.Column(db.String(200), nullable=False)\n    description = db.Column(db.Text)\n    category_id = db.Column(db.Integer, db.ForeignKey('categories.id'), nullable=False)\n    supplier_id = db.Column(db.Integer, db.ForeignKey('suppliers.id'))\n    unit = db.Column(db.String(20), default='unidade')  # unidade, kg, litro, etc.\n    purchase_price = db.Column(db.Numeric(10, 2), default=0.00)\n    sale_price = db.Column(db.Numeric(10, 2), nullable=False)\n    stock_quantity = db.Column(db.Integer, default=0)\n    min_stock = db.Column(db.Integer, default=5)\n    max_stock = db.Column(db.Integer, default=100)\n    tax_rate = db.Column(db.Numeric(5, 2), default=23.00)  # IVA em Portugal\n    is_active = db.Column(db.Boolean, default=True)\n    created_at = db.Column(db.DateTime, default=datetime.utcnow)\n    updated_at = db.Column(db.DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)\n    \n    # Relationships\n    sale_items = db.relationship('SaleItem', backref='product', lazy=True)\n    purchase_items = db.relationship('PurchaseItem', backref='product', lazy=True)\n    inventory_movements = db.relationship('InventoryMovement', backref='product', lazy=True)\n\n    @property\n    def profit_margin(self):\n        if self.purchase_price and self.purchase_price > 0:\n            return ((self.sale_price - self.purchase_price) / self.purchase_price) * 100\n        return 0\n\n    @property\n    def stock_status(self):\n        if self.stock_quantity <= self.min_stock:\n            return 'baixo'\n        elif self.stock_quantity >= self.max_stock:\n            return 'alto'\n        return 'normal'\n\nclass Sale(db.Model):\n    __tablename__ = 'sales'\n    \n    id = db.Column(db.Integer, primary_key=True)\n    invoice_number = db.Column(db.String(50), unique=True, nullable=False)\n    customer_id = db.Column(db.Integer, db.ForeignKey('customers.id'), nullable=False)\n    user_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False)\n    sale_date = db.Column(db.DateTime, default=datetime.utcnow)\n    due_date = db.Column(db.DateTime)\n    subtotal = db.Column(db.Numeric(10, 2), default=0.00)\n    tax_amount = db.Column(db.Numeric(10, 2), default=0.00)\n    total_amount = db.Column(db.Numeric(10, 2), default=0.00)\n    discount = db.Column(db.Numeric(10, 2), default=0.00)\n    status = db.Column(db.String(50), default='pendente')  # pendente, pago, cancelado\n    payment_method = db.Column(db.String(50))  # dinheiro, cartao, transferencia\n    notes = db.Column(db.Text)\n    created_at = db.Column(db.DateTime, default=datetime.utcnow)\n    updated_at = db.Column(db.DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)\n    \n    # Relationships\n    user = db.relationship('User', backref='sales')\n    items = db.relationship('SaleItem', backref='sale', lazy=True, cascade='all, delete-orphan')\n\nclass SaleItem(db.Model):\n    __tablename__ = 'sale_items'\n    \n    id = db.Column(db.Integer, primary_key=True)\n    sale_id = db.Column(db.Integer, db.ForeignKey('sales.id'), nullable=False)\n    product_id = db.Column(db.Integer, db.ForeignKey('products.id'), nullable=False)\n    quantity = db.Column(db.Integer, nullable=False)\n    unit_price = db.Column(db.Numeric(10, 2), nullable=False)\n    tax_rate = db.Column(db.Numeric(5, 2), default=23.00)\n    total_price = db.Column(db.Numeric(10, 2), nullable=False)\n\nclass Purchase(db.Model):\n    __tablename__ = 'purchases'\n    \n    id = db.Column(db.Integer, primary_key=True)\n    invoice_number = db.Column(db.String(50), unique=True, nullable=False)\n    supplier_id = db.Column(db.Integer, db.ForeignKey('suppliers.id'), nullable=False)\n    user_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False)\n    purchase_date = db.Column(db.DateTime, default=datetime.utcnow)\n    due_date = db.Column(db.DateTime)\n    subtotal = db.Column(db.Numeric(10, 2), default=0.00)\n    tax_amount = db.Column(db.Numeric(10, 2), default=0.00)\n    total_amount = db.Column(db.Numeric(10, 2), default=0.00)\n    status = db.Column(db.String(50), default='pendente')  # pendente, recebido, cancelado\n    payment_method = db.Column(db.String(50))\n    notes = db.Column(db.Text)\n    created_at = db.Column(db.DateTime, default=datetime.utcnow)\n    updated_at = db.Column(db.DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)\n    \n    # Relationships\n    user = db.relationship('User', backref='purchases')\n    items = db.relationship('PurchaseItem', backref='purchase', lazy=True, cascade='all, delete-orphan')\n\nclass PurchaseItem(db.Model):\n    __tablename__ = 'purchase_items'\n    \n    id = db.Column(db.Integer, primary_key=True)\n    purchase_id = db.Column(db.Integer, db.ForeignKey('purchases.id'), nullable=False)\n    product_id = db.Column(db.Integer, db.ForeignKey('products.id'), nullable=False)\n    quantity = db.Column(db.Integer, nullable=False)\n    unit_price = db.Column(db.Numeric(10, 2), nullable=False)\n    tax_rate = db.Column(db.Numeric(5, 2), default=23.00)\n    total_price = db.Column(db.Numeric(10, 2), nullable=False)\n\nclass InventoryMovement(db.Model):\n    __tablename__ = 'inventory_movements'\n    \n    id = db.Column(db.Integer, primary_key=True)\n    product_id = db.Column(db.Integer, db.ForeignKey('products.id'), nullable=False)\n    movement_type = db.Column(db.String(50), nullable=False)  # entrada, saida, ajuste\n    quantity = db.Column(db.Integer, nullable=False)\n    reference_type = db.Column(db.String(50))  # venda, compra, ajuste\n    reference_id = db.Column(db.Integer)\n    notes = db.Column(db.Text)\n    created_at = db.Column(db.DateTime, default=datetime.utcnow)\n    user_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False)\n    \n    # Relationships\n    user = db.relationship('User', backref='inventory_movements')\n\nclass Configuration(db.Model):\n    __tablename__ = 'configurations'\n    \n    id = db.Column(db.Integer, primary_key=True)\n    key = db.Column(db.String(100), unique=True, nullable=False)\n    value = db.Column(db.Text)\n    description = db.Column(db.Text)\n    data_type = db.Column(db.String(50), default='string')  # string, integer, boolean, decimal\n    created_at = db.Column(db.DateTime, default=datetime.utcnow)\n    updated_at = db.Column(db.DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)\n","size_bytes":9700},"pyproject.toml":{"content":"[project]\nname = \"repl-nix-workspace\"\nversion = \"0.1.0\"\ndescription = \"Add your description here\"\nrequires-python = \">=3.11\"\ndependencies = [\n    \"email-validator>=2.2.0\",\n    \"flask-login>=0.6.3\",\n    \"flask>=3.1.1\",\n    \"flask-sqlalchemy>=3.1.1\",\n    \"gunicorn>=23.0.0\",\n    \"psycopg2-binary>=2.9.10\",\n    \"sqlalchemy>=2.0.42\",\n    \"werkzeug>=3.1.3\",\n    \"flask-wtf>=1.2.2\",\n    \"sendgrid>=6.12.4\",\n]\n","size_bytes":403},"replit.md":{"content":"# Overview\n\nGestVendas is a comprehensive sales and purchase management system built with Flask. The application provides functionality for managing users, categories, suppliers, customers, products, sales, purchases, and inventory movements. It includes a dashboard interface, user authentication, and administrative features for business operations management.\n\n# User Preferences\n\nPreferred communication style: Simple, everyday language.\n\n# Recent Changes\n\n## Advanced Purchase System (August 2025)\n- Implemented comprehensive purchase management system similar to sales\n- Supplier selection from database with contact information display\n- Product selection with purchase price calculation and stock validation\n- Real-time calculation of subtotal, IVA, and total amounts\n- Automatic stock increases when purchases are completed\n- Integration with PurchaseItem model for detailed transaction tracking\n- Inventory movement tracking for purchase transactions (entrada type)\n- Corrected model field names (invoice_number vs purchase_number, subtotal vs subtotal_amount)\n\n## Advanced Sales System (August 2025)\n- Implemented advanced sales system with customer and product selection\n- Real-time calculation of subtotal, IVA, and total amounts\n- Dynamic product selection from inventory with stock validation\n- Automatic stock updates when sales are completed\n- Interactive interface with product search and selection modal\n- Integration with SaleItem model for detailed transaction tracking\n- Inventory movement tracking for sales transactions\n\n## User Registration System (August 2025)\n- Implemented complete user registration with email confirmation\n- Added SendGrid email integration for confirmation emails\n- Enhanced login system to support username OR email authentication\n- Added database field `confirmation_token` to User model\n- Created registration form with password validation and confirmation\n- Users receive confirmation email and must activate account before login\n- Added fallback admin login (admin/admin123) for development\n\n## Comprehensive Reports System (August 2025)\n- Created detailed reporting system with 4 main sections\n- Sales reports with transaction history and analytics\n- Product reports with performance metrics and stock alerts\n- Purchase reports with supplier transaction tracking\n- Financial reports with profit/loss analysis and charts\n- Interactive filtering by time period (7, 30, 90, 365 days)\n- Chart.js integration for visual data representation\n- DataTables for searchable and sortable report listings\n\n# System Architecture\n\n## Backend Architecture\n- **Framework**: Flask web framework with SQLAlchemy ORM\n- **Database**: PostgreSQL with SQLAlchemy models for data persistence\n- **Authentication**: Session-based authentication with password hashing using Werkzeug\n- **Application Structure**: Modular design with separate files for models, routes, and utilities\n- **Configuration Management**: Environment-based configuration with default fallbacks\n\n## Database Design\n- **User Management**: Users table with role-based access control (admin/user roles)\n- **Product Management**: Categories, suppliers, and products with relationships\n- **Transaction Tracking**: Sales, purchases, and inventory movements with item-level details\n- **System Configuration**: Configurable settings for currency, tax rates, and company information\n- **Audit Trail**: Created/updated timestamps on all major entities\n\n## Frontend Architecture\n- **Template Engine**: Flask's Jinja2 templating system\n- **CSS Framework**: Bootstrap 5 for responsive design\n- **JavaScript**: Vanilla JavaScript with modular app structure\n- **UI Components**: DataTables for data grids, Chart.js for analytics, Flatpickr for date selection\n- **Responsive Design**: Mobile-first approach with collapsible sidebar navigation\n\n## Key Features\n- **Dashboard**: Real-time analytics and business metrics\n- **Inventory Management**: Stock tracking with minimum/maximum levels\n- **Sales Processing**: Invoice generation with automatic numbering\n- **Purchase Management**: Supplier purchase tracking\n- **User Management**: Multi-user support with role-based permissions and user registration\n- **Financial Reporting**: Currency formatting and tax calculations\n- **CRUD Operations**: Complete create, read, update, delete functionality for all entities\n- **Data Validation**: Form validation with required fields and type checking\n- **Automated Numbering**: Unique invoice numbers for sales and purchases\n- **User Registration**: Email confirmation system with SendGrid integration\n- **Authentication**: Login with username or email support\n\n## Security Measures\n- **Password Security**: Werkzeug password hashing\n- **Session Management**: Flask session handling with secret key\n- **Environment Variables**: Sensitive configuration via environment variables\n- **Database Security**: Connection pooling and pre-ping health checks\n\n# External Dependencies\n\n## Core Framework Dependencies\n- **Flask**: Web application framework\n- **SQLAlchemy**: Database ORM and query builder\n- **Werkzeug**: WSGI utilities and security functions\n\n## Frontend Libraries\n- **Bootstrap 5**: CSS framework for responsive design\n- **Font Awesome**: Icon library for UI elements\n- **DataTables**: Advanced table functionality with sorting/filtering\n- **Chart.js**: Data visualization and analytics charts\n- **Flatpickr**: Modern date picker component\n\n## Database\n- **Supabase PostgreSQL**: Cloud-hosted PostgreSQL database with real-time capabilities\n- **Connection**: Direct SQLAlchemy connection using Supabase's PostgreSQL connection string\n- **Migration Strategy**: SQLAlchemy create_all() for initial setup, manual schema updates as needed\n- **Connection Pooling**: Built-in SQLAlchemy connection management with transaction pooler\n\n## Production Considerations\n- **ProxyFix**: Werkzeug middleware for reverse proxy deployments\n- **Environment Configuration**: Support for production environment variables\n- **Logging**: Configurable logging system for debugging and monitoring","size_bytes":6052},"routes.py":{"content":"from flask import render_template, request, redirect, url_for, flash, jsonify, session\nfrom app import app, db\nfrom models import (User, Category, Supplier, Customer, Product, Sale, SaleItem, \n                   Purchase, PurchaseItem, InventoryMovement, Configuration)\nfrom utils import format_currency, generate_invoice_number, calculate_totals\nfrom sqlalchemy import func, desc, asc\nfrom datetime import datetime, timedelta\nimport logging\n\n# Initialize default user and configurations when database is available\ndef initialize_default_data():\n    try:\n        with app.app_context():\n            # Create default admin user if it doesn't exist\n            admin_user = User.query.filter_by(username='admin').first()\n            if not admin_user:\n                admin_user = User(\n                    username='admin',\n                    email='admin@gestvendas.com',\n                    full_name='Administrador',\n                    role='admin'\n                )\n                admin_user.set_password('admin123')\n                db.session.add(admin_user)\n                \n            # Create default configurations\n            default_configs = [\n                {'key': 'currency', 'value': 'EUR', 'description': 'Moeda padrão do sistema'},\n                {'key': 'currency_symbol', 'value': '€', 'description': 'Símbolo da moeda'},\n                {'key': 'tax_rate', 'value': '23.00', 'description': 'Taxa de IVA padrão (%)', 'data_type': 'decimal'},\n                {'key': 'company_name', 'value': 'GestVendas', 'description': 'Nome da empresa'},\n                {'key': 'company_address', 'value': '', 'description': 'Endereço da empresa'},\n                {'key': 'company_tax_number', 'value': '', 'description': 'Número fiscal da empresa'},\n            ]\n            \n            for config_data in default_configs:\n                existing_config = Configuration.query.filter_by(key=config_data['key']).first()\n                if not existing_config:\n                    config = Configuration(**config_data)\n                    db.session.add(config)\n            \n            db.session.commit()\n            return True\n    except Exception as e:\n        logging.error(f\"Error creating default data: {e}\")\n        if 'session' in locals():\n            db.session.rollback()\n        return False\n\n# Helper function to check if user is logged in\ndef login_required():\n    return session.get('user_id') is not None\n\n@app.route('/')\ndef index():\n    if not login_required():\n        return redirect(url_for('login'))\n    \n    # Get dashboard statistics\n    today = datetime.utcnow().date()\n    month_start = today.replace(day=1)\n    \n    # Sales statistics\n    total_sales = db.session.query(func.sum(Sale.total_amount)).filter(\n        Sale.status != 'cancelado'\n    ).scalar() or 0\n    \n    monthly_sales = db.session.query(func.sum(Sale.total_amount)).filter(\n        Sale.sale_date >= month_start,\n        Sale.status != 'cancelado'\n    ).scalar() or 0\n    \n    # Purchase statistics  \n    total_purchases = db.session.query(func.sum(Purchase.total_amount)).filter(\n        Purchase.status != 'cancelado'\n    ).scalar() or 0\n    \n    monthly_purchases = db.session.query(func.sum(Purchase.total_amount)).filter(\n        Purchase.purchase_date >= month_start,\n        Purchase.status != 'cancelado'\n    ).scalar() or 0\n    \n    # Inventory alerts\n    low_stock_products = Product.query.filter(\n        Product.stock_quantity <= Product.min_stock,\n        Product.is_active == True\n    ).count()\n    \n    # Recent sales\n    recent_sales = Sale.query.join(Customer).add_columns(\n        Customer.name.label('customer_name')\n    ).order_by(desc(Sale.created_at)).limit(5).all()\n    \n    # Products needing restock\n    restock_products = Product.query.filter(\n        Product.stock_quantity <= Product.min_stock,\n        Product.is_active == True\n    ).limit(5).all()\n    \n    stats = {\n        'total_sales': total_sales,\n        'monthly_sales': monthly_sales,\n        'total_purchases': total_purchases,\n        'monthly_purchases': monthly_purchases,\n        'profit': total_sales - total_purchases,\n        'low_stock_alerts': low_stock_products,\n        'recent_sales': recent_sales,\n        'restock_products': restock_products\n    }\n    \n    return render_template('index.html', stats=stats)\n\n@app.route('/login', methods=['GET', 'POST'])\ndef login():\n    if request.method == 'POST':\n        username = request.form['username']\n        password = request.form['password']\n        \n        user = User.query.filter_by(username=username, is_active=True).first()\n        \n        if user and user.check_password(password):\n            session['user_id'] = user.id\n            session['username'] = user.username\n            session['user_role'] = user.role\n            flash('Login realizado com sucesso!', 'success')\n            return redirect(url_for('index'))\n        else:\n            flash('Credenciais inválidas!', 'error')\n    \n    return render_template('login.html')\n\n@app.route('/logout')\ndef logout():\n    session.clear()\n    flash('Logout realizado com sucesso!', 'success')\n    return redirect(url_for('login'))\n\n# Products routes\n@app.route('/products')\ndef products():\n    if not login_required():\n        return redirect(url_for('login'))\n    \n    page = request.args.get('page', 1, type=int)\n    search = request.args.get('search', '')\n    category_id = request.args.get('category', type=int)\n    \n    query = Product.query.join(Category).join(Supplier, isouter=True)\n    \n    if search:\n        query = query.filter(Product.name.contains(search) | Product.code.contains(search))\n    \n    if category_id:\n        query = query.filter(Product.category_id == category_id)\n    \n    products = query.order_by(Product.name).paginate(\n        page=page, per_page=20, error_out=False\n    )\n    \n    categories = Category.query.filter_by(is_active=True).all()\n    \n    return render_template('products.html', products=products, categories=categories, \n                         search=search, selected_category=category_id)\n\n@app.route('/products/add', methods=['GET', 'POST'])\ndef add_product():\n    if not login_required():\n        return redirect(url_for('login'))\n    \n    if request.method == 'POST':\n        try:\n            product = Product(\n                code=request.form['code'],\n                name=request.form['name'],\n                description=request.form.get('description', ''),\n                category_id=request.form['category_id'],\n                supplier_id=request.form.get('supplier_id') or None,\n                unit=request.form.get('unit', 'unidade'),\n                purchase_price=float(request.form.get('purchase_price', 0)),\n                sale_price=float(request.form['sale_price']),\n                stock_quantity=int(request.form.get('stock_quantity', 0)),\n                min_stock=int(request.form.get('min_stock', 5)),\n                max_stock=int(request.form.get('max_stock', 100)),\n                tax_rate=float(request.form.get('tax_rate', 23.00))\n            )\n            \n            db.session.add(product)\n            db.session.commit()\n            \n            flash('Produto adicionado com sucesso!', 'success')\n            return redirect(url_for('products'))\n            \n        except Exception as e:\n            db.session.rollback()\n            flash(f'Erro ao adicionar produto: {str(e)}', 'error')\n    \n    categories = Category.query.filter_by(is_active=True).all()\n    suppliers = Supplier.query.filter_by(is_active=True).all()\n    \n    return render_template('product_form.html', categories=categories, suppliers=suppliers)\n\n# Sales routes\n@app.route('/sales')\ndef sales():\n    if not login_required():\n        return redirect(url_for('login'))\n    \n    page = request.args.get('page', 1, type=int)\n    sales = Sale.query.join(Customer).add_columns(\n        Customer.name.label('customer_name')\n    ).order_by(desc(Sale.created_at)).paginate(\n        page=page, per_page=20, error_out=False\n    )\n    \n    return render_template('sales.html', sales=sales)\n\n@app.route('/sales/add', methods=['GET', 'POST'])\ndef add_sale():\n    if not login_required():\n        return redirect(url_for('login'))\n    \n    if request.method == 'POST':\n        try:\n            # Create sale\n            sale = Sale(\n                invoice_number=generate_invoice_number('V'),\n                customer_id=request.form['customer_id'],\n                user_id=session['user_id'],\n                sale_date=datetime.strptime(request.form['sale_date'], '%Y-%m-%d'),\n                payment_method=request.form.get('payment_method'),\n                notes=request.form.get('notes', '')\n            )\n            \n            db.session.add(sale)\n            db.session.flush()  # Get the sale ID\n            \n            # Add sale items\n            products_data = request.form.getlist('products')\n            quantities = request.form.getlist('quantities')\n            unit_prices = request.form.getlist('unit_prices')\n            \n            subtotal = 0\n            tax_total = 0\n            \n            for i, product_id in enumerate(products_data):\n                if product_id and quantities[i] and unit_prices[i]:\n                    product = Product.query.get(product_id)\n                    quantity = int(quantities[i])\n                    unit_price = float(unit_prices[i])\n                    total_price = quantity * unit_price\n                    tax_amount = total_price * (product.tax_rate / 100)\n                    \n                    sale_item = SaleItem(\n                        sale_id=sale.id,\n                        product_id=product_id,\n                        quantity=quantity,\n                        unit_price=unit_price,\n                        tax_rate=product.tax_rate,\n                        total_price=total_price\n                    )\n                    \n                    db.session.add(sale_item)\n                    \n                    # Update stock\n                    product.stock_quantity -= quantity\n                    \n                    # Create inventory movement\n                    movement = InventoryMovement(\n                        product_id=product_id,\n                        movement_type='saida',\n                        quantity=quantity,\n                        reference_type='venda',\n                        reference_id=sale.id,\n                        user_id=session['user_id']\n                    )\n                    db.session.add(movement)\n                    \n                    subtotal += total_price\n                    tax_total += tax_amount\n            \n            # Update sale totals\n            sale.subtotal = subtotal\n            sale.tax_amount = tax_total\n            sale.total_amount = subtotal + tax_total\n            \n            db.session.commit()\n            flash('Venda registrada com sucesso!', 'success')\n            return redirect(url_for('sales'))\n            \n        except Exception as e:\n            db.session.rollback()\n            flash(f'Erro ao registrar venda: {str(e)}', 'error')\n    \n    customers = Customer.query.filter_by(is_active=True).all()\n    products = Product.query.filter_by(is_active=True).all()\n    \n    return render_template('sale_form.html', customers=customers, products=products)\n\n# Customers routes\n@app.route('/customers')\ndef customers():\n    if not login_required():\n        return redirect(url_for('login'))\n    \n    page = request.args.get('page', 1, type=int)\n    search = request.args.get('search', '')\n    \n    query = Customer.query\n    if search:\n        query = query.filter(Customer.name.contains(search) | Customer.email.contains(search))\n    \n    customers = query.order_by(Customer.name).paginate(\n        page=page, per_page=20, error_out=False\n    )\n    \n    return render_template('customers.html', customers=customers, search=search)\n\n@app.route('/customers/add', methods=['GET', 'POST'])\ndef add_customer():\n    if not login_required():\n        return redirect(url_for('login'))\n    \n    if request.method == 'POST':\n        try:\n            customer = Customer(\n                name=request.form['name'],\n                email=request.form.get('email', ''),\n                phone=request.form.get('phone', ''),\n                address=request.form.get('address', ''),\n                city=request.form.get('city', ''),\n                postal_code=request.form.get('postal_code', ''),\n                country=request.form.get('country', 'Portugal'),\n                tax_number=request.form.get('tax_number', ''),\n                customer_type=request.form.get('customer_type', 'particular')\n            )\n            \n            db.session.add(customer)\n            db.session.commit()\n            \n            flash('Cliente adicionado com sucesso!', 'success')\n            return redirect(url_for('customers'))\n            \n        except Exception as e:\n            db.session.rollback()\n            flash(f'Erro ao adicionar cliente: {str(e)}', 'error')\n    \n    return render_template('customer_form.html')\n\n# API routes for AJAX requests\n@app.route('/api/products/search')\ndef api_search_products():\n    if not login_required():\n        return jsonify({'error': 'Unauthorized'}), 401\n    \n    query = request.args.get('q', '')\n    products = Product.query.filter(\n        Product.name.contains(query) | Product.code.contains(query),\n        Product.is_active == True\n    ).limit(10).all()\n    \n    result = []\n    for product in products:\n        result.append({\n            'id': product.id,\n            'code': product.code,\n            'name': product.name,\n            'sale_price': float(product.sale_price),\n            'stock_quantity': product.stock_quantity,\n            'unit': product.unit\n        })\n    \n    return jsonify(result)\n\n@app.route('/api/dashboard/charts')\ndef api_dashboard_charts():\n    if not login_required():\n        return jsonify({'error': 'Unauthorized'}), 401\n    \n    # Get sales data for the last 12 months\n    end_date = datetime.utcnow()\n    start_date = end_date - timedelta(days=365)\n    \n    monthly_sales = db.session.query(\n        func.date_trunc('month', Sale.sale_date).label('month'),\n        func.sum(Sale.total_amount).label('total')\n    ).filter(\n        Sale.sale_date >= start_date,\n        Sale.status != 'cancelado'\n    ).group_by('month').order_by('month').all()\n    \n    sales_data = {\n        'labels': [sale.month.strftime('%b %Y') for sale in monthly_sales],\n        'data': [float(sale.total) for sale in monthly_sales]\n    }\n    \n    # Get top products by sales\n    top_products = db.session.query(\n        Product.name,\n        func.sum(SaleItem.quantity).label('quantity_sold'),\n        func.sum(SaleItem.total_price).label('revenue')\n    ).join(SaleItem).join(Sale).filter(\n        Sale.status != 'cancelado'\n    ).group_by(Product.id, Product.name).order_by(\n        desc('revenue')\n    ).limit(5).all()\n    \n    products_data = {\n        'labels': [product.name for product in top_products],\n        'quantities': [int(product.quantity_sold) for product in top_products],\n        'revenues': [float(product.revenue) for product in top_products]\n    }\n    \n    return jsonify({\n        'sales': sales_data,\n        'products': products_data\n    })\n\n# Error handlers\n@app.errorhandler(404)\ndef not_found(error):\n    return render_template('error.html', \n                         error_code=404,\n                         error_message='Página não encontrada'), 404\n\n@app.errorhandler(500)\ndef internal_error(error):\n    db.session.rollback()\n    return render_template('error.html',\n                         error_code=500,\n                         error_message='Erro interno do servidor'), 500\n\n# Context processors\n@app.context_processor\ndef inject_utils():\n    return {\n        'format_currency': format_currency,\n        'current_user_id': session.get('user_id'),\n        'current_username': session.get('username'),\n        'current_user_role': session.get('user_role')\n    }\n","size_bytes":16007},"simple_routes.py":{"content":"from flask import render_template, request, redirect, url_for, flash, session\nfrom app import app, db\nfrom datetime import datetime\nimport secrets\n\n@app.route('/')\ndef index():\n    return render_template('login.html')\n\n@app.route('/login', methods=['GET', 'POST'])\ndef login():\n    if request.method == 'POST':\n        login_field = request.form.get('login_field', '').strip()  # Can be username or email\n        password = request.form.get('password', '')\n        \n        try:\n            from models import User\n            from werkzeug.security import check_password_hash\n            \n            # Find user by username or email\n            user = User.query.filter(\n                (User.username == login_field) | (User.email == login_field)\n            ).first()\n            \n            if user and check_password_hash(user.password_hash, password):\n                if not user.is_active:\n                    flash('Conta não ativada. Verifique o seu email para ativar a conta.', 'error')\n                else:\n                    session['user_id'] = user.id\n                    session['username'] = user.username\n                    session['user_role'] = user.role\n                    session['full_name'] = user.full_name\n                    flash(f'Bem-vindo de volta, {user.full_name}!', 'success')\n                    return redirect(url_for('dashboard'))\n            else:\n                flash('Credenciais inválidas. Verifique o utilizador/email e palavra-passe.', 'error')\n                \n        except Exception as e:\n            print(f\"Error during login: {e}\")\n            # Fallback to admin login for development\n            if login_field == 'admin' and password == 'admin123':\n                session['user_id'] = 1\n                session['username'] = login_field\n                session['user_role'] = 'admin'\n                session['full_name'] = 'Administrador'\n                flash('Login realizado com sucesso!', 'success')\n                return redirect(url_for('dashboard'))\n            else:\n                flash('Erro durante o login. Tente novamente.', 'error')\n    \n    return render_template('login.html')\n\n@app.route('/dashboard')\ndef dashboard():\n    if not session.get('user_id'):\n        return redirect(url_for('login'))\n    \n    # Mock dashboard data for now\n    stats = {\n        'monthly_sales': 0,\n        'total_sales': 0,\n        'monthly_purchases': 0,\n        'total_purchases': 0,\n        'profit': 0,\n        'low_stock_alerts': 0,\n        'recent_sales': [],\n        'restock_products': []\n    }\n    \n    return render_template('index.html', stats=stats)\n\n@app.route('/logout')\ndef logout():\n    session.clear()\n    flash('Logout realizado com sucesso!', 'success')\n    return redirect(url_for('login'))\n\n# Database setup using direct SQL\n@app.route('/setup-db')\ndef setup_db():\n    try:\n        from app import db\n        import models  # Import to ensure tables are defined\n        \n        # Create all tables\n        db.create_all()\n        \n        # Execute raw SQL to ensure proper setup\n        sql_commands = [\n            # Create admin user\n            \"\"\"\n            INSERT INTO users (username, email, password_hash, full_name, role, is_active, created_at, updated_at)\n            SELECT 'admin', 'admin@gestvendas.com', 'scrypt:32768:8:1$pPzReLiL5gLTDZD6$1db227ba4a74326cd7fb48fede70048d419011180540945f5706604f4090eecc90789fee9ebf31d3df5c1fb5be0180f8528671085754c4fcb41a6e7af36fac26', 'Administrador', 'admin', true, NOW(), NOW()\n            WHERE NOT EXISTS (SELECT 1 FROM users WHERE username = 'admin');\n            \"\"\",\n            \n            # Create categories\n            \"\"\"\n            INSERT INTO categories (name, description, is_active, created_at, updated_at)\n            SELECT unnest(ARRAY['Eletrónicos', 'Roupas', 'Casa e Jardim', 'Alimentação', 'Livros']),\n                   unnest(ARRAY['Categoria Eletrónicos', 'Categoria Roupas', 'Categoria Casa e Jardim', 'Categoria Alimentação', 'Categoria Livros']),\n                   true, NOW(), NOW()\n            WHERE NOT EXISTS (SELECT 1 FROM categories);\n            \"\"\",\n            \n            # Create default supplier\n            \"\"\"\n            INSERT INTO suppliers (name, email, phone, address, is_active, created_at, updated_at)\n            SELECT 'Fornecedor Geral', 'fornecedor@example.com', '210000000', 'Lisboa, Portugal', true, NOW(), NOW()\n            WHERE NOT EXISTS (SELECT 1 FROM suppliers WHERE name = 'Fornecedor Geral');\n            \"\"\",\n            \n            # Create configurations\n            \"\"\"\n            INSERT INTO configurations (key, value, description, data_type, created_at, updated_at)\n            SELECT unnest(ARRAY['currency', 'currency_symbol', 'tax_rate', 'company_name']),\n                   unnest(ARRAY['EUR', '€', '23.00', 'GestVendas']),\n                   unnest(ARRAY['Moeda padrão do sistema', 'Símbolo da moeda', 'Taxa de IVA padrão (%)', 'Nome da empresa']),\n                   unnest(ARRAY['string', 'string', 'decimal', 'string']),\n                   NOW(), NOW()\n            WHERE NOT EXISTS (SELECT 1 FROM configurations);\n            \"\"\"\n        ]\n        \n        for sql in sql_commands:\n            try:\n                db.session.execute(db.text(sql))\n            except Exception as e:\n                # Continue even if individual commands fail\n                print(f\"SQL command failed: {e}\")\n        \n        db.session.commit()\n        \n        return \"\"\"\n        <style>\n            body { font-family: Arial, sans-serif; margin: 40px; }\n            .success { color: green; }\n            .info { background: #f0f8ff; padding: 20px; border-radius: 5px; }\n        </style>\n        <div class=\"info\">\n            <h2 class=\"success\">✓ Base de dados configurada!</h2>\n            <p>✓ Tabelas criadas no Supabase</p>\n            <p>✓ Utilizador admin disponível</p>\n            <p>✓ Dados iniciais inseridos</p>\n            <p><strong>Credenciais:</strong> admin / admin123</p>\n            <p><a href=\"/\" style=\"color: blue;\">← Voltar ao login</a></p>\n        </div>\n        \"\"\"\n        \n    except Exception as e:\n        return f\"\"\"\n        <style>body {{ font-family: Arial, sans-serif; margin: 40px; }}</style>\n        <h2 style=\"color: red;\">Erro na configuração</h2>\n        <p>Detalhes: {str(e)}</p>\n        <p><a href=\"/test-db\">Testar ligação à base de dados</a></p>\n        \"\"\"\n\n# Database connection test route\n@app.route('/test-db')\ndef test_db():\n    try:\n        from app import db\n        from models import User\n        \n        # Test database connection\n        users = User.query.all()\n        return f\"Ligação à base de dados bem-sucedida! Encontrados {len(users)} utilizadores.\"\n    except Exception as e:\n        return f\"Falha na ligação à base de dados: {str(e)}\"\n\n# Products routes\n@app.route('/products')\ndef products():\n    if not session.get('user_id'):\n        return redirect(url_for('login'))\n    \n    try:\n        from models import Category, Product\n        \n        # Get categories safely\n        categories = []\n        try:\n            categories_query = Category.query.filter_by(is_active=True)\n            categories = list(categories_query.all())\n        except Exception as cat_error:\n            print(f\"Category query error: {cat_error}\")\n        \n        # Get products safely\n        products_list = []\n        try:\n            products_query = Product.query.filter_by(is_active=True)\n            products_list = list(products_query.all())\n        except Exception as prod_error:\n            print(f\"Product query error: {prod_error}\")\n        \n        products_data = {\n            'data': products_list,\n            'total': len(products_list)\n        }\n        \n        return render_template('products.html', \n                             products=products_data, \n                             categories=categories, \n                             search='', \n                             selected_category='')\n    except Exception as e:\n        print(f\"Products route error: {e}\")\n        flash(f'Erro ao carregar produtos: {str(e)}', 'error')\n        return redirect(url_for('dashboard'))\n\n# Customers routes  \n@app.route('/customers')\ndef customers():\n    if not session.get('user_id'):\n        return redirect(url_for('login'))\n    \n    customers_list = []\n    # Simple, safe query without complex error handling\n    try:\n        from models import Customer\n        results = Customer.query.all()\n        customers_list = [customer for customer in results if customer.is_active]\n    except Exception as e:\n        print(f\"Customer query error: {e}\")\n        customers_list = []\n    \n    customers_data = {\n        'data': customers_list,\n        'total': len(customers_list)\n    }\n    \n    return render_template('customers.html', \n                         customers=customers_data, \n                         search='')\n\n# Suppliers routes\n@app.route('/suppliers') \ndef suppliers():\n    if not session.get('user_id'):\n        return redirect(url_for('login'))\n    \n    suppliers_list = []\n    # Simple, safe query without complex error handling\n    try:\n        from models import Supplier\n        results = Supplier.query.all()\n        suppliers_list = [supplier for supplier in results if supplier.is_active]\n    except Exception as e:\n        print(f\"Supplier query error: {e}\")\n        suppliers_list = []\n    \n    suppliers_data = {\n        'data': suppliers_list,\n        'total': len(suppliers_list)\n    }\n    \n    return render_template('suppliers.html', \n                         suppliers=suppliers_data, \n                         search='')\n\n# Sales routes\n@app.route('/sales')\ndef sales():\n    if not session.get('user_id'):\n        return redirect(url_for('login'))\n    \n    try:\n        sales_list = []\n        try:\n            from models import Sale\n            sales_query = Sale.query\n            sales_list = list(sales_query.all())\n        except Exception as sales_error:\n            print(f\"Sales query error: {sales_error}\")\n        \n        sales_data = {\n            'data': sales_list,\n            'total': len(sales_list)\n        }\n        \n        return render_template('sales.html', sales=sales_data)\n    except Exception as e:\n        print(f\"Sales route error: {e}\")\n        flash(f'Erro ao carregar vendas: {str(e)}', 'error')\n        return redirect(url_for('dashboard'))\n\n# Purchases routes  \n@app.route('/purchases')\ndef purchases():\n    if not session.get('user_id'):\n        return redirect(url_for('login'))\n    \n    try:\n        purchases_list = []\n        try:\n            from models import Purchase\n            purchases_query = Purchase.query\n            purchases_list = list(purchases_query.all())\n        except Exception as purch_error:\n            print(f\"Purchase query error: {purch_error}\")\n        \n        purchases_data = {\n            'data': purchases_list,\n            'total': len(purchases_list)\n        }\n        \n        return render_template('purchases.html', purchases=purchases_data)\n    except Exception as e:\n        print(f\"Purchases route error: {e}\")\n        flash(f'Erro ao carregar compras: {str(e)}', 'error')\n        return redirect(url_for('dashboard'))\n\n# Inventory routes\n@app.route('/inventory')\ndef inventory():\n    if not session.get('user_id'):\n        return redirect(url_for('login'))\n    \n    try:\n        inventory_list = []\n        try:\n            from models import InventoryMovement\n            inventory_query = InventoryMovement.query\n            inventory_list = list(inventory_query.all())\n        except Exception as inv_error:\n            print(f\"Inventory query error: {inv_error}\")\n        \n        inventory_data = {\n            'data': inventory_list,\n            'total': len(inventory_list)\n        }\n        \n        return render_template('inventory.html', inventory=inventory_data)\n    except Exception as e:\n        print(f\"Inventory route error: {e}\")\n        flash(f'Erro ao carregar inventário: {str(e)}', 'error')\n        return redirect(url_for('dashboard'))\n\n# Reports routes\n@app.route('/reports')\ndef reports():\n    if not session.get('user_id'):\n        return redirect(url_for('login'))\n    \n    from models import Sale, Purchase, Product, Customer, Supplier, SaleItem, PurchaseItem\n    from datetime import datetime, timedelta\n    from sqlalchemy import func, desc\n    \n    try:\n        # Get period filter (default 30 days)\n        period_days = int(request.args.get('period', 30))\n        start_date = datetime.now() - timedelta(days=period_days)\n        \n        # Sales data\n        sales_query = Sale.query.filter(Sale.sale_date >= start_date)\n        recent_sales = sales_query.order_by(desc(Sale.sale_date)).limit(20).all()\n        sales_count = sales_query.count()\n        total_sales = sales_query.with_entities(func.sum(Sale.total_amount)).scalar() or 0\n        \n        # Purchases data\n        purchases_query = Purchase.query.filter(Purchase.purchase_date >= start_date)\n        recent_purchases = purchases_query.order_by(desc(Purchase.purchase_date)).limit(20).all()\n        purchases_count = purchases_query.count()\n        total_purchases = purchases_query.with_entities(func.sum(Purchase.total_amount)).scalar() or 0\n        \n        # Products data with sales performance\n        products_with_stats = db.session.query(\n            Product,\n            func.coalesce(func.sum(SaleItem.quantity), 0).label('sales_count'),\n            func.coalesce(func.sum(SaleItem.quantity * SaleItem.unit_price), 0).label('total_revenue')\n        ).outerjoin(SaleItem).outerjoin(Sale).filter(\n            func.coalesce(Sale.sale_date, datetime.now()) >= start_date\n        ).group_by(Product.id).order_by(desc('total_revenue')).limit(20).all()\n        \n        # Format products data\n        top_products = []\n        for product, sales_count, total_revenue in products_with_stats:\n            product.sales_count = sales_count\n            product.total_revenue = total_revenue\n            top_products.append(product)\n        \n        # General stats\n        products_count = Product.query.count()\n        low_stock_count = Product.query.filter(\n            Product.stock_quantity <= Product.min_stock\n        ).count()\n        customers_count = Customer.query.count()\n        suppliers_count = Supplier.query.count()\n        \n        # Tax calculations\n        total_tax = (sales_query.with_entities(func.sum(Sale.tax_amount)).scalar() or 0) - \\\n                   (purchases_query.with_entities(func.sum(Purchase.tax_amount)).scalar() or 0)\n        \n        # Financial chart data (last 7 days)\n        financial_data = None\n        if period_days <= 30:\n            chart_days = min(period_days, 7)\n            labels = []\n            sales_data = []\n            purchases_data = []\n            \n            for i in range(chart_days):\n                day = datetime.now() - timedelta(days=chart_days - 1 - i)\n                labels.append(day.strftime('%d/%m'))\n                \n                day_sales = Sale.query.filter(\n                    func.date(Sale.sale_date) == day.date()\n                ).with_entities(func.sum(Sale.total_amount)).scalar() or 0\n                \n                day_purchases = Purchase.query.filter(\n                    func.date(Purchase.purchase_date) == day.date()\n                ).with_entities(func.sum(Purchase.total_amount)).scalar() or 0\n                \n                sales_data.append(float(day_sales))\n                purchases_data.append(float(day_purchases))\n            \n            financial_data = {\n                'labels': labels,\n                'sales': sales_data,\n                'purchases': purchases_data\n            }\n        \n        return render_template('reports.html',\n                             recent_sales=recent_sales,\n                             recent_purchases=recent_purchases,\n                             top_products=top_products,\n                             total_sales=total_sales,\n                             total_purchases=total_purchases,\n                             sales_count=sales_count,\n                             purchases_count=purchases_count,\n                             products_count=products_count,\n                             low_stock_count=low_stock_count,\n                             customers_count=customers_count,\n                             suppliers_count=suppliers_count,\n                             total_tax=total_tax,\n                             financial_data=financial_data)\n    \n    except Exception as e:\n        print(f\"Error generating reports: {e}\")\n        flash('Erro ao gerar relatórios.', 'error')\n        return redirect(url_for('dashboard'))\n\n# Analytics routes  \n@app.route('/analytics')\ndef analytics():\n    if not session.get('user_id'):\n        return redirect(url_for('login'))\n    \n    return render_template('analytics.html')\n\n@app.context_processor\ndef inject_user():\n    return dict(\n        current_user_id=session.get('user_id'),\n        current_username=session.get('username'),\n        current_user_role=session.get('user_role')\n    )\n\n@app.template_filter('currency')\ndef currency_filter(amount):\n    if amount is None:\n        amount = 0\n    return f\"{amount:,.2f} €\"\n\n# Register the filter\napp.jinja_env.filters['currency'] = currency_filter\n\ndef format_currency(amount):\n    if amount is None:\n        amount = 0\n    return f\"{amount:,.2f} €\"\n\napp.jinja_env.globals.update(format_currency=format_currency)\n\n# =============== ADD ROUTES ===============\n\n# Add Product\n@app.route('/products/add', methods=['GET', 'POST'])\ndef add_product():\n    if not session.get('user_id'):\n        return redirect(url_for('login'))\n    \n    if request.method == 'POST':\n        try:\n            from models import Product, Category\n            \n            # Generate unique invoice number\n            code = request.form.get('code')\n            name = request.form.get('name')\n            \n            # Check if code already exists\n            existing_product = Product.query.filter_by(code=code).first()\n            if existing_product:\n                flash('Código do produto já existe. Use um código diferente.', 'error')\n                return redirect(url_for('add_product'))\n            \n            new_product = Product(\n                code=code,\n                name=name,\n                description=request.form.get('description', ''),\n                category_id=int(request.form.get('category_id') or 1),\n                unit=request.form.get('unit', 'un'),\n                purchase_price=float(request.form.get('purchase_price') or 0),\n                sale_price=float(request.form.get('sale_price') or 0),\n                tax_rate=float(request.form.get('tax_rate') or 23),\n                stock_quantity=int(request.form.get('stock_quantity') or 0),\n                min_stock=int(request.form.get('min_stock') or 0),\n                max_stock=int(request.form.get('max_stock') or 100),\n                is_active=True,\n                created_at=datetime.now(),\n                updated_at=datetime.now()\n            )\n            \n            db.session.add(new_product)\n            db.session.commit()\n            \n            flash('Produto adicionado com sucesso!', 'success')\n            return redirect(url_for('products'))\n            \n        except Exception as e:\n            db.session.rollback()\n            print(f\"Error adding product: {e}\")\n            flash(f'Erro ao adicionar produto: {str(e)}', 'error')\n    \n    # Get categories for dropdown\n    categories = []\n    try:\n        from models import Category\n        categories = Category.query.all()\n    except Exception as e:\n        print(f\"Error loading categories: {e}\")\n    \n    return render_template('forms/add_product.html', categories=categories)\n\n# Add Customer\n@app.route('/customers/add', methods=['GET', 'POST'])\ndef add_customer():\n    if not session.get('user_id'):\n        return redirect(url_for('login'))\n    \n    if request.method == 'POST':\n        try:\n            from models import Customer\n            \n            new_customer = Customer(\n                name=request.form.get('name', ''),\n                email=request.form.get('email', ''),\n                phone=request.form.get('phone', ''),\n                address=request.form.get('address', ''),\n                city=request.form.get('city', ''),\n                postal_code=request.form.get('postal_code', ''),\n                country=request.form.get('country', 'Portugal'),\n                tax_number=request.form.get('tax_number', ''),\n                customer_type=request.form.get('customer_type', 'particular'),\n                is_active=bool(request.form.get('is_active')),\n                created_at=datetime.now(),\n                updated_at=datetime.now()\n            )\n            \n            db.session.add(new_customer)\n            db.session.commit()\n            \n            flash('Cliente adicionado com sucesso!', 'success')\n            return redirect(url_for('customers'))\n            \n        except Exception as e:\n            db.session.rollback()\n            print(f\"Error adding customer: {e}\")\n            flash(f'Erro ao adicionar cliente: {str(e)}', 'error')\n    \n    return render_template('forms/add_customer.html')\n\n# Add Supplier\n@app.route('/suppliers/add', methods=['GET', 'POST'])\ndef add_supplier():\n    if not session.get('user_id'):\n        return redirect(url_for('login'))\n    \n    if request.method == 'POST':\n        try:\n            from models import Supplier\n            \n            new_supplier = Supplier(\n                name=request.form.get('name', ''),\n                contact_person=request.form.get('contact_person', ''),\n                email=request.form.get('email', ''),\n                phone=request.form.get('phone', ''),\n                address=request.form.get('address', ''),\n                city=request.form.get('city', ''),\n                postal_code=request.form.get('postal_code', ''),\n                country=request.form.get('country', 'Portugal'),\n                tax_number=request.form.get('tax_number', ''),\n                is_active=bool(request.form.get('is_active')),\n                created_at=datetime.now(),\n                updated_at=datetime.now()\n            )\n            \n            db.session.add(new_supplier)\n            db.session.commit()\n            \n            flash('Fornecedor adicionado com sucesso!', 'success')\n            return redirect(url_for('suppliers'))\n            \n        except Exception as e:\n            db.session.rollback()\n            print(f\"Error adding supplier: {e}\")\n            flash(f'Erro ao adicionar fornecedor: {str(e)}', 'error')\n    \n    return render_template('forms/add_supplier.html')\n\n# Add Sale - Advanced Version\n@app.route('/sales/add', methods=['GET', 'POST'])\ndef add_sale():\n    if not session.get('user_id'):\n        return redirect(url_for('login'))\n    \n    if request.method == 'POST':\n        try:\n            from models import Sale, SaleItem, Product, InventoryMovement\n            \n            # Generate unique invoice number\n            invoice_number = f\"VEN{datetime.now().strftime('%Y%m%d')}{secrets.token_hex(3).upper()}\"\n            \n            # Parse dates\n            sale_date_str = request.form.get('sale_date')\n            due_date_str = request.form.get('due_date')\n            \n            sale_date = datetime.strptime(sale_date_str, '%Y-%m-%d').date() if sale_date_str else datetime.now().date()\n            due_date = datetime.strptime(due_date_str, '%Y-%m-%d').date() if due_date_str else None\n            \n            # Create sale\n            new_sale = Sale(\n                invoice_number=invoice_number,\n                customer_id=int(request.form.get('customer_id')),\n                user_id=session['user_id'],\n                sale_date=sale_date,\n                due_date=due_date,\n                subtotal=float(request.form.get('subtotal', 0)),\n                tax_amount=float(request.form.get('tax_amount', 0)),\n                total_amount=float(request.form.get('total_amount', 0)),\n                status='concluida',\n                payment_method=request.form.get('payment_method', 'multibanco'),\n                notes=request.form.get('notes', ''),\n                created_at=datetime.now(),\n                updated_at=datetime.now()\n            )\n            \n            db.session.add(new_sale)\n            db.session.flush()  # Get the sale ID\n            \n            # Process sale items\n            products_data = {}\n            for key, value in request.form.items():\n                if key.startswith('products[') and key.endswith(']'):\n                    # Parse products[0][id], products[0][price], etc.\n                    import re\n                    match = re.match(r'products\\[(\\d+)\\]\\[(\\w+)\\]', key)\n                    if match:\n                        index, field = match.groups()\n                        if index not in products_data:\n                            products_data[index] = {}\n                        products_data[index][field] = value\n            \n            # Create sale items and update inventory\n            for product_data in products_data.values():\n                if not all(k in product_data for k in ['id', 'price', 'quantity', 'tax_rate']):\n                    continue\n                    \n                product_id = int(product_data['id'])\n                quantity = int(product_data['quantity'])\n                unit_price = float(product_data['price'])\n                tax_rate = float(product_data['tax_rate'])\n                \n                # Calculate totals\n                subtotal = quantity * unit_price\n                tax_amount = subtotal * (tax_rate / 100)\n                total_price = subtotal + tax_amount\n                \n                # Create sale item\n                sale_item = SaleItem(\n                    sale_id=new_sale.id,\n                    product_id=product_id,\n                    quantity=quantity,\n                    unit_price=unit_price,\n                    tax_rate=tax_rate,\n                    total_price=total_price\n                )\n                db.session.add(sale_item)\n                \n                # Update product stock\n                product = Product.query.get(product_id)\n                if product:\n                    product.stock_quantity = max(0, product.stock_quantity - quantity)\n                    product.updated_at = datetime.now()\n                    \n                    # Create inventory movement\n                    movement = InventoryMovement(\n                        product_id=product_id,\n                        movement_type='saida',\n                        quantity=-quantity,\n                        reference_type='venda',\n                        reference_id=new_sale.id,\n                        notes=f'Venda {invoice_number}',\n                        user_id=session['user_id'],\n                        created_at=datetime.now()\n                    )\n                    db.session.add(movement)\n            \n            db.session.commit()\n            \n            flash('Venda registada com sucesso!', 'success')\n            return redirect(url_for('sales'))\n            \n        except Exception as e:\n            db.session.rollback()\n            print(f\"Error adding sale: {e}\")\n            flash(f'Erro ao registar venda: {str(e)}', 'error')\n    \n    # GET request - load form data\n    try:\n        from models import Customer, Product\n        customers = Customer.query.filter_by(is_active=True).all()\n        products = Product.query.filter_by(is_active=True).filter(Product.stock_quantity > 0).all()\n        \n        return render_template('forms/advanced_sale.html', \n                             customers=customers, \n                             products=products,\n                             today=datetime.now().strftime('%Y-%m-%d'))\n    except Exception as e:\n        print(f\"Error loading form data: {e}\")\n        flash('Erro ao carregar dados do formulário.', 'error')\n        return redirect(url_for('sales'))\n\n# Add Purchase\n@app.route('/purchases/add', methods=['GET', 'POST'])\ndef add_purchase():\n    if not session.get('user_id'):\n        return redirect(url_for('login'))\n    \n    if request.method == 'POST':\n        try:\n            from models import Purchase\n            \n            # Generate unique invoice number\n            invoice_number = f\"COM{datetime.now().strftime('%Y%m%d')}{secrets.token_hex(3).upper()}\"\n            \n            # Safely parse dates\n            purchase_date_str = request.form.get('purchase_date')\n            due_date_str = request.form.get('due_date')\n            \n            purchase_date = datetime.strptime(purchase_date_str, '%Y-%m-%d').date() if purchase_date_str else datetime.now().date()\n            due_date = datetime.strptime(due_date_str, '%Y-%m-%d').date() if due_date_str else None\n            \n            new_purchase = Purchase(\n                invoice_number=invoice_number,\n                supplier_id=int(request.form.get('supplier_id') or 1),\n                user_id=session['user_id'],\n                purchase_date=purchase_date,\n                due_date=due_date,\n                subtotal=float(request.form.get('subtotal') or 0),\n                tax_amount=float(request.form.get('tax_amount') or 0),\n                total_amount=float(request.form.get('total_amount') or 0),\n                status=request.form.get('status', 'concluida'),\n                payment_method=request.form.get('payment_method', 'transferencia'),\n                notes=request.form.get('notes', ''),\n                created_at=datetime.now(),\n                updated_at=datetime.now()\n            )\n            \n            db.session.add(new_purchase)\n            db.session.flush()  # Get purchase ID\n            \n            # Process products from form\n            products_data = {}\n            for key, value in request.form.items():\n                if key.startswith('products['):\n                    # Parse products[0][id], products[0][price], etc.\n                    import re\n                    match = re.match(r'products\\[(\\d+)\\]\\[(\\w+)\\]', key)\n                    if match:\n                        index, field = match.groups()\n                        if index not in products_data:\n                            products_data[index] = {}\n                        products_data[index][field] = value\n            \n            # Create purchase items and update inventory\n            for product_data in products_data.values():\n                if not all(k in product_data for k in ['id', 'price', 'quantity', 'tax_rate']):\n                    continue\n                    \n                product_id = int(product_data['id'])\n                quantity = int(product_data['quantity'])\n                unit_price = float(product_data['price'])\n                tax_rate = float(product_data['tax_rate'])\n                \n                # Calculate totals\n                subtotal = quantity * unit_price\n                tax_amount = subtotal * (tax_rate / 100)\n                total_price = subtotal + tax_amount\n                \n                # Create purchase item\n                from models import PurchaseItem\n                purchase_item = PurchaseItem(\n                    purchase_id=new_purchase.id,\n                    product_id=product_id,\n                    quantity=quantity,\n                    unit_price=unit_price,\n                    tax_rate=tax_rate,\n                    total_price=total_price\n                )\n                db.session.add(purchase_item)\n                \n                # Update product stock (increase for purchase)\n                from models import Product\n                product = Product.query.get(product_id)\n                if product:\n                    product.stock_quantity += quantity\n                    product.updated_at = datetime.now()\n                    \n                    # Create inventory movement\n                    from models import InventoryMovement\n                    movement = InventoryMovement(\n                        product_id=product_id,\n                        movement_type='entrada',\n                        quantity=quantity,\n                        reference_type='compra',\n                        reference_id=new_purchase.id,\n                        notes=f'Compra {invoice_number}',\n                        user_id=session['user_id'],\n                        created_at=datetime.now()\n                    )\n                    db.session.add(movement)\n            \n            db.session.commit()\n            \n            flash('Compra registada com sucesso!', 'success')\n            return redirect(url_for('purchases'))\n            \n        except Exception as e:\n            db.session.rollback()\n            print(f\"Error adding purchase: {e}\")\n            flash(f'Erro ao registar compra: {str(e)}', 'error')\n    \n    # Get suppliers for dropdown\n    suppliers = []\n    try:\n        from models import Supplier\n        suppliers = Supplier.query.filter_by(is_active=True).all()\n    except Exception as e:\n        print(f\"Error loading suppliers: {e}\")\n    \n    # Get products for selection\n    products = []\n    try:\n        from models import Product\n        products = Product.query.filter_by(is_active=True).all()\n    except Exception as e:\n        print(f\"Error loading products: {e}\")\n    \n    return render_template('forms/advanced_purchase.html', \n                         suppliers=suppliers, \n                         products=products,\n                         today=datetime.now().strftime('%Y-%m-%d'))\n\n# Add Inventory Movement\n@app.route('/inventory/add', methods=['GET', 'POST'])\ndef add_inventory():\n    if not session.get('user_id'):\n        return redirect(url_for('login'))\n    \n    if request.method == 'POST':\n        try:\n            from models import InventoryMovement\n            \n            new_movement = InventoryMovement(\n                product_id=int(request.form.get('product_id') or 1),\n                movement_type=request.form.get('movement_type', 'entrada'),\n                quantity=int(request.form.get('quantity') or 0),\n                reference_type=request.form.get('reference_type', 'manual'),\n                reference_id=int(request.form.get('reference_id') or 0) if request.form.get('reference_id') else None,\n                notes=request.form.get('notes', ''),\n                user_id=session['user_id'],\n                created_at=datetime.now()\n            )\n            \n            db.session.add(new_movement)\n            db.session.commit()\n            \n            flash('Movimento de inventário registado com sucesso!', 'success')\n            return redirect(url_for('inventory'))\n            \n        except Exception as e:\n            db.session.rollback()\n            print(f\"Error adding inventory movement: {e}\")\n            flash(f'Erro ao registar movimento: {str(e)}', 'error')\n    \n    # Get products for dropdown\n    products = []\n    try:\n        from models import Product\n        products = Product.query.all()\n    except Exception as e:\n        print(f\"Error loading products: {e}\")\n    \n    return render_template('forms/add_inventory.html', products=products)\n\n# =============== DELETE ROUTES ===============\n\n# Delete Product\n@app.route('/products/delete/<int:id>')\ndef delete_product(id):\n    if not session.get('user_id'):\n        return redirect(url_for('login'))\n    \n    try:\n        from models import Product\n        product = Product.query.get_or_404(id)\n        \n        db.session.delete(product)\n        db.session.commit()\n        \n        flash('Produto eliminado com sucesso!', 'success')\n    except Exception as e:\n        db.session.rollback()\n        print(f\"Error deleting product: {e}\")\n        flash(f'Erro ao eliminar produto: {str(e)}', 'error')\n    \n    return redirect(url_for('products'))\n\n# Delete Customer\n@app.route('/customers/delete/<int:id>')\ndef delete_customer(id):\n    if not session.get('user_id'):\n        return redirect(url_for('login'))\n    \n    try:\n        from models import Customer\n        customer = Customer.query.get_or_404(id)\n        \n        db.session.delete(customer)\n        db.session.commit()\n        \n        flash('Cliente eliminado com sucesso!', 'success')\n    except Exception as e:\n        db.session.rollback()\n        print(f\"Error deleting customer: {e}\")\n        flash(f'Erro ao eliminar cliente: {str(e)}', 'error')\n    \n    return redirect(url_for('customers'))\n\n# Delete Supplier\n@app.route('/suppliers/delete/<int:id>')\ndef delete_supplier(id):\n    if not session.get('user_id'):\n        return redirect(url_for('login'))\n    \n    try:\n        from models import Supplier\n        supplier = Supplier.query.get_or_404(id)\n        \n        db.session.delete(supplier)\n        db.session.commit()\n        \n        flash('Fornecedor eliminado com sucesso!', 'success')\n    except Exception as e:\n        db.session.rollback()\n        print(f\"Error deleting supplier: {e}\")\n        flash(f'Erro ao eliminar fornecedor: {str(e)}', 'error')\n    \n    return redirect(url_for('suppliers'))\n\n# Delete Sale\n@app.route('/sales/delete/<int:id>')\ndef delete_sale(id):\n    if not session.get('user_id'):\n        return redirect(url_for('login'))\n    \n    try:\n        from models import Sale\n        sale = Sale.query.get_or_404(id)\n        \n        db.session.delete(sale)\n        db.session.commit()\n        \n        flash('Venda eliminada com sucesso!', 'success')\n    except Exception as e:\n        db.session.rollback()\n        print(f\"Error deleting sale: {e}\")\n        flash(f'Erro ao eliminar venda: {str(e)}', 'error')\n    \n    return redirect(url_for('sales'))\n\n# Delete Purchase\n@app.route('/purchases/delete/<int:id>')\ndef delete_purchase(id):\n    if not session.get('user_id'):\n        return redirect(url_for('login'))\n    \n    try:\n        from models import Purchase\n        purchase = Purchase.query.get_or_404(id)\n        \n        db.session.delete(purchase)\n        db.session.commit()\n        \n        flash('Compra eliminada com sucesso!', 'success')\n    except Exception as e:\n        db.session.rollback()\n        print(f\"Error deleting purchase: {e}\")\n        flash(f'Erro ao eliminar compra: {str(e)}', 'error')\n    \n    return redirect(url_for('purchases'))\n\n# Delete Inventory Movement\n@app.route('/inventory/delete/<int:id>')\ndef delete_inventory_movement(id):\n    if not session.get('user_id'):\n        return redirect(url_for('login'))\n    \n    try:\n        from models import InventoryMovement\n        movement = InventoryMovement.query.get_or_404(id)\n        \n        db.session.delete(movement)\n        db.session.commit()\n        \n        flash('Movimento de inventário eliminado com sucesso!', 'success')\n    except Exception as e:\n        db.session.rollback()\n        print(f\"Error deleting inventory movement: {e}\")\n        flash(f'Erro ao eliminar movimento: {str(e)}', 'error')\n    \n    return redirect(url_for('inventory'))\n\n# User Registration Routes\n@app.route('/register', methods=['GET', 'POST'])\ndef register():\n    if request.method == 'POST':\n        try:\n            from models import User\n            from werkzeug.security import generate_password_hash\n            import secrets\n            \n            # Get form data\n            username = request.form.get('username', '').strip()\n            email = request.form.get('email', '').strip()\n            full_name = request.form.get('full_name', '').strip()\n            password = request.form.get('password', '')\n            confirm_password = request.form.get('confirm_password', '')\n            \n            # Validation\n            if not all([username, email, full_name, password]):\n                flash('Todos os campos são obrigatórios.', 'error')\n                return render_template('register.html')\n            \n            if password != confirm_password:\n                flash('As palavras-passe não coincidem.', 'error')\n                return render_template('register.html')\n            \n            if len(password) < 6:\n                flash('A palavra-passe deve ter pelo menos 6 caracteres.', 'error')\n                return render_template('register.html')\n            \n            # Check if user already exists\n            existing_user = User.query.filter((User.username == username) | (User.email == email)).first()\n            if existing_user:\n                flash('Utilizador ou email já existem.', 'error')\n                return render_template('register.html')\n            \n            # Generate confirmation token\n            confirmation_token = secrets.token_urlsafe(32)\n            \n            # Create new user\n            new_user = User(\n                username=username,\n                email=email,\n                full_name=full_name,\n                password_hash=generate_password_hash(password),\n                role='user',\n                is_active=False,  # User needs to confirm email\n                confirmation_token=confirmation_token,\n                created_at=datetime.now(),\n                updated_at=datetime.now()\n            )\n            \n            db.session.add(new_user)\n            db.session.commit()\n            \n            # Send confirmation email\n            email_sent = send_confirmation_email(email, full_name, confirmation_token)\n            \n            if email_sent:\n                flash('Registo realizado com sucesso! Verifique o seu email para confirmar a conta.', 'success')\n            else:\n                # For now, auto-activate accounts when email can't be sent\n                new_user.is_active = True\n                new_user.confirmation_token = None\n                db.session.commit()\n                flash('Registo realizado com sucesso! A sua conta foi ativada automaticamente. Pode fazer login agora.', 'success')\n            return redirect(url_for('login'))\n            \n        except Exception as e:\n            db.session.rollback()\n            print(f\"Error during registration: {e}\")\n            flash('Erro durante o registo. Tente novamente.', 'error')\n    \n    return render_template('register.html')\n\n@app.route('/confirm-email/<token>')\ndef confirm_email(token):\n    try:\n        from models import User\n        \n        user = User.query.filter_by(confirmation_token=token).first()\n        if not user:\n            flash('Token de confirmação inválido ou expirado.', 'error')\n            return redirect(url_for('login'))\n        \n        user.is_active = True\n        user.confirmation_token = None\n        user.updated_at = datetime.now()\n        \n        db.session.commit()\n        \n        flash('Email confirmado com sucesso! Pode agora fazer login.', 'success')\n        return render_template('email_confirmed.html')\n        \n    except Exception as e:\n        print(f\"Error confirming email: {e}\")\n        flash('Erro ao confirmar email. Tente novamente.', 'error')\n        return redirect(url_for('login'))\n\ndef send_confirmation_email(email, full_name, token):\n    \"\"\"Send email confirmation using SendGrid\"\"\"\n    try:\n        import os\n        from sendgrid import SendGridAPIClient\n        from sendgrid.helpers.mail import Mail\n        \n        # Check if SendGrid API key is available\n        sendgrid_key = os.environ.get('SENDGRID_API_KEY')\n        if not sendgrid_key:\n            print(\"SendGrid API key not configured - email not sent\")\n            return False\n        \n        # Use the user's verified email as sender (single sender verification)\n        # For production, configure a verified domain or single sender in SendGrid\n        verified_sender = os.environ.get('VERIFIED_SENDER_EMAIL', 'admin@gestvendas.com')\n        \n        print(f\"Attempting to send email to: {email}\")\n        print(f\"From: {verified_sender}\")\n        print(f\"Subject: Confirme o seu registo - GestVendas\")\n        \n        # Create confirmation URL\n        base_url = request.url_root\n        confirmation_url = f\"{base_url}confirm-email/{token}\"\n        \n        # Email content\n        html_content = f\"\"\"\n        <div style=\"font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;\">\n            <h2 style=\"color: #007bff;\">Bem-vindo ao GestVendas!</h2>\n            <p>Olá {full_name},</p>\n            <p>Obrigado por se registar no GestVendas. Para ativar a sua conta, clique no botão abaixo:</p>\n            <p style=\"text-align: center; margin: 30px 0;\">\n                <a href=\"{confirmation_url}\" \n                   style=\"background-color: #007bff; color: white; padding: 12px 24px; \n                          text-decoration: none; border-radius: 4px; display: inline-block;\">\n                    Confirmar Email\n                </a>\n            </p>\n            <p>Se não conseguir clicar no botão, copie e cole este link no seu navegador:</p>\n            <p><a href=\"{confirmation_url}\">{confirmation_url}</a></p>\n            <p>Este link expira em 24 horas.</p>\n            <br>\n            <p>Cumprimentos,<br>Equipa GestVendas</p>\n        </div>\n        \"\"\"\n        \n        message = Mail(\n            from_email=verified_sender,\n            to_emails=email,\n            subject='Confirme o seu registo - GestVendas',\n            html_content=html_content\n        )\n        \n        sg = SendGridAPIClient(sendgrid_key)\n        response = sg.send(message)\n        \n        print(f\"Email sent successfully: {response.status_code}\")\n        return True\n        \n    except Exception as e:\n        print(f\"Error sending email: {e}\")\n        return False\n\n# Admin routes for user management\n@app.route('/admin/users')\ndef admin_activate_users():\n    if not session.get('user_id') or session.get('user_role') != 'admin':\n        flash('Acesso negado. Apenas administradores podem aceder a esta página.', 'error')\n        return redirect(url_for('login'))\n    \n    from models import User\n    \n    try:\n        # Get pending users (not active)\n        pending_users = User.query.filter_by(is_active=False).all()\n        \n        # Get all users\n        all_users = User.query.all()\n        \n        return render_template('admin_activate_users.html', \n                             pending_users=pending_users,\n                             all_users=all_users)\n    except Exception as e:\n        print(f\"Error loading users: {e}\")\n        flash('Erro ao carregar utilizadores.', 'error')\n        return redirect(url_for('dashboard'))\n\n@app.route('/admin/activate-user/<int:id>')\ndef admin_activate_user(id):\n    if not session.get('user_id') or session.get('user_role') != 'admin':\n        flash('Acesso negado.', 'error')\n        return redirect(url_for('login'))\n    \n    from models import User\n    \n    try:\n        user = User.query.get_or_404(id)\n        user.is_active = True\n        user.confirmation_token = None\n        user.updated_at = datetime.now()\n        \n        db.session.commit()\n        \n        flash(f'Utilizador {user.username} ativado com sucesso!', 'success')\n    except Exception as e:\n        db.session.rollback()\n        print(f\"Error activating user: {e}\")\n        flash('Erro ao ativar utilizador.', 'error')\n    \n    return redirect(url_for('admin_activate_users'))\n\n@app.route('/admin/delete-user/<int:id>')\ndef delete_user(id):\n    if not session.get('user_id') or session.get('user_role') != 'admin':\n        flash('Acesso negado.', 'error')\n        return redirect(url_for('login'))\n    \n    from models import User\n    \n    try:\n        user = User.query.get_or_404(id)\n        username = user.username\n        \n        db.session.delete(user)\n        db.session.commit()\n        \n        flash(f'Utilizador {username} eliminado com sucesso!', 'success')\n    except Exception as e:\n        db.session.rollback()\n        print(f\"Error deleting user: {e}\")\n        flash('Erro ao eliminar utilizador.', 'error')\n    \n    return redirect(url_for('admin_activate_users'))","size_bytes":47948},"utils.py":{"content":"from datetime import datetime\nimport secrets\nimport string\n\ndef format_currency(amount, currency_symbol='€'):\n    \"\"\"Format amount as currency with Euro symbol\"\"\"\n    if amount is None:\n        amount = 0\n    return f\"{amount:,.2f} {currency_symbol}\".replace(',', ' ').replace('.', ',').replace(' ', '.')\n\ndef generate_invoice_number(prefix='V'):\n    \"\"\"Generate unique invoice number with prefix\"\"\"\n    year = datetime.now().year\n    timestamp = datetime.now().strftime('%m%d%H%M%S')\n    random_part = ''.join(secrets.choice(string.digits) for _ in range(3))\n    return f\"{prefix}{year}{timestamp}{random_part}\"\n\ndef calculate_totals(items):\n    \"\"\"Calculate subtotal, tax and total for a list of items\"\"\"\n    subtotal = 0\n    tax_total = 0\n    \n    for item in items:\n        item_total = item['quantity'] * item['unit_price']\n        item_tax = item_total * (item.get('tax_rate', 23) / 100)\n        \n        subtotal += item_total\n        tax_total += item_tax\n    \n    return {\n        'subtotal': subtotal,\n        'tax_total': tax_total,\n        'total': subtotal + tax_total\n    }\n\ndef get_stock_status_class(stock_quantity, min_stock, max_stock):\n    \"\"\"Get CSS class for stock status\"\"\"\n    if stock_quantity <= min_stock:\n        return 'status-badge-danger'\n    elif stock_quantity >= max_stock:\n        return 'status-badge-warning'\n    return 'status-badge-success'\n\ndef get_stock_status_text(stock_quantity, min_stock, max_stock):\n    \"\"\"Get text for stock status\"\"\"\n    if stock_quantity <= min_stock:\n        return 'Stock Baixo'\n    elif stock_quantity >= max_stock:\n        return 'Stock Alto'\n    return 'Stock Normal'\n\ndef validate_tax_number(tax_number, country='PT'):\n    \"\"\"Basic validation for Portuguese tax numbers (NIF)\"\"\"\n    if not tax_number:\n        return True  # Optional field\n    \n    if country == 'PT':\n        # Remove spaces and non-digits\n        clean_number = ''.join(filter(str.isdigit, tax_number))\n        \n        # Portuguese NIF should have 9 digits\n        if len(clean_number) != 9:\n            return False\n            \n        # Basic check digit validation for Portuguese NIF\n        digits = [int(d) for d in clean_number]\n        check_sum = sum(digit * (9 - i) for i, digit in enumerate(digits[:-1]))\n        check_digit = 11 - (check_sum % 11)\n        \n        if check_digit >= 10:\n            check_digit = 0\n            \n        return check_digit == digits[-1]\n    \n    return True  # For other countries, accept any format\n\ndef format_date(date_obj, format_str='%d/%m/%Y'):\n    \"\"\"Format date object to Portuguese format\"\"\"\n    if date_obj:\n        return date_obj.strftime(format_str)\n    return ''\n\ndef format_datetime(datetime_obj, format_str='%d/%m/%Y %H:%M'):\n    \"\"\"Format datetime object to Portuguese format\"\"\"\n    if datetime_obj:\n        return datetime_obj.strftime(format_str)\n    return ''\n\ndef pagination_info(pagination):\n    \"\"\"Generate pagination information text\"\"\"\n    if pagination.total == 0:\n        return \"Nenhum registo encontrado\"\n    \n    start = (pagination.page - 1) * pagination.per_page + 1\n    end = min(pagination.page * pagination.per_page, pagination.total)\n    \n    return f\"Mostrando {start} a {end} de {pagination.total} registos\"\n\ndef safe_float(value, default=0.0):\n    \"\"\"Safely convert value to float\"\"\"\n    try:\n        return float(value) if value else default\n    except (ValueError, TypeError):\n        return default\n\ndef safe_int(value, default=0):\n    \"\"\"Safely convert value to integer\"\"\"\n    try:\n        return int(value) if value else default\n    except (ValueError, TypeError):\n        return default\n","size_bytes":3619},"static/css/style.css":{"content":":root {\n    --primary: #2563eb;\n    --secondary: #64748b;\n    --success: #22c55e;\n    --danger: #ef4444;\n    --warning: #eab308;\n    --info: #0ea5e9;\n    --light: #f1f5f9;\n    --dark: #0f172a;\n}\n\nbody {\n    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;\n    background-color: #f8fafc;\n    color: #334155;\n    overflow-x: hidden;\n}\n\n.sidebar {\n    position: fixed;\n    top: 0;\n    left: 0;\n    height: 100%;\n    width: 250px;\n    z-index: 100;\n    background-color: var(--dark);\n    color: white;\n    box-shadow: 2px 0 10px rgba(0,0,0,0.1);\n    transition: all 0.3s;\n}\n\n.sidebar-collapsed {\n    width: 70px;\n}\n\n.sidebar-brand {\n    padding: 1.5rem 1rem;\n    border-bottom: 1px solid rgba(255,255,255,0.1);\n    display: flex;\n    align-items: center;\n}\n\n.sidebar-brand h1 {\n    font-size: 1.5rem;\n    margin: 0;\n    white-space: nowrap;\n}\n\n.sidebar-nav {\n    padding: 1rem 0.5rem;\n}\n\n.sidebar-heading {\n    padding: 0.5rem 1rem;\n    font-size: 0.75rem;\n    text-transform: uppercase;\n    letter-spacing: 0.1em;\n    color: rgba(255,255,255,0.5);\n    white-space: nowrap;\n}\n\n.sidebar-item {\n    padding: 0.7rem 1rem;\n    display: flex;\n    align-items: center;\n    border-radius: 0.375rem;\n    margin-bottom: 0.25rem;\n    color: rgba(255,255,255,0.7);\n    transition: all 0.3s;\n    cursor: pointer;\n}\n\n.sidebar-item:hover {\n    background-color: rgba(255,255,255,0.1);\n    color: white;\n}\n\n.sidebar-item.active {\n    background-color: var(--primary);\n    color: white;\n}\n\n.sidebar-item i {\n    margin-right: 0.75rem;\n    font-size: 1.1rem;\n    width: 1.5rem;\n    text-align: center;\n}\n\n.sidebar-item .text {\n    white-space: nowrap;\n}\n\n.sidebar-collapsed .text,\n.sidebar-collapsed .sidebar-heading,\n.sidebar-collapsed .brand-text {\n    display: none;\n}\n\n.main-content {\n    margin-left: 250px;\n    transition: all 0.3s;\n    padding: 1rem;\n    min-height: 100vh;\n}\n\n.main-content.expanded {\n    margin-left: 70px;\n}\n\n.top-bar {\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n    padding: 1rem 0;\n    margin-bottom: 1rem;\n}\n\n.toggle-sidebar {\n    border: none;\n    background: none;\n    color: var(--secondary);\n    font-size: 1.25rem;\n    cursor: pointer;\n}\n\n.user-info {\n    display: flex;\n    align-items: center;\n}\n\n.dash-card {\n    background: white;\n    border-radius: 0.5rem;\n    box-shadow: 0 4px 6px rgba(0,0,0,0.05);\n    padding: 1.5rem;\n    margin-bottom: 1.5rem;\n    transition: transform 0.3s;\n    border-left: 4px solid var(--primary);\n}\n\n.dash-card:hover {\n    transform: translateY(-5px);\n}\n\n.dash-card.sales {\n    border-left-color: var(--success);\n}\n\n.dash-card.purchases {\n    border-left-color: var(--warning);\n}\n\n.dash-card.profit {\n    border-left-color: var(--info);\n}\n\n.dash-card.alerts {\n    border-left-color: var(--danger);\n}\n\n.dash-card h5 {\n    color: var(--secondary);\n    font-size: 0.9rem;\n    margin-bottom: 0.5rem;\n}\n\n.dash-card .value {\n    font-size: 1.75rem;\n    font-weight: 700;\n    margin-bottom: 0.25rem;\n}\n\n.dash-card .trend {\n    font-size: 0.85rem;\n}\n\n.dash-card .icon {\n    float: right;\n    font-size: 2.5rem;\n    opacity: 0.2;\n    margin-top: -3rem;\n}\n\n.chart-container {\n    background: white;\n    border-radius: 0.5rem;\n    box-shadow: 0 4px 6px rgba(0,0,0,0.05);\n    padding: 1.5rem;\n    margin-bottom: 1.5rem;\n}\n\n.data-card {\n    background: white;\n    border-radius: 0.5rem;\n    box-shadow: 0 4px 6px rgba(0,0,0,0.05);\n    padding: 1.5rem;\n    margin-bottom: 1.5rem;\n}\n\n.data-card .header {\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n    margin-bottom: 1rem;\n    border-bottom: 1px solid #e2e8f0;\n    padding-bottom: 0.75rem;\n}\n\n.alert-item {\n    display: flex;\n    align-items: center;\n    padding: 0.75rem 0;\n    border-bottom: 1px solid #e2e8f0;\n}\n\n.alert-item:last-child {\n    border-bottom: none;\n}\n\n.alert-item .alert-icon {\n    background: rgba(239, 68, 68, 0.1);\n    color: var(--danger);\n    width: 40px;\n    height: 40px;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    border-radius: 50%;\n    margin-right: 1rem;\n}\n\n.alert-item .alert-info {\n    flex: 1;\n}\n\n.alert-item .alert-title {\n    font-weight: 600;\n}\n\n.alert-item .alert-desc {\n    color: var(--secondary);\n    font-size: 0.85rem;\n}\n\n.loading {\n    display: none;\n    position: fixed;\n    top: 0;\n    left: 0;\n    right: 0;\n    bottom: 0;\n    background-color: rgba(255, 255, 255, 0.7);\n    z-index: 9999;\n    justify-content: center;\n    align-items: center;\n}\n\n.loading.active {\n    display: flex;\n}\n\n.spinner {\n    width: 40px;\n    height: 40px;\n    border: 4px solid rgba(37, 99, 235, 0.2);\n    border-top-color: var(--primary);\n    border-radius: 50%;\n    animation: spin 1s linear infinite;\n}\n\n@keyframes spin {\n    to { transform: rotate(360deg); }\n}\n\n.toast-container {\n    position: fixed;\n    top: 20px;\n    right: 20px;\n    z-index: 1060;\n}\n\n.toast {\n    background-color: white;\n    color: var(--dark);\n    box-shadow: 0 4px 6px rgba(0,0,0,0.1);\n}\n\n.toast-header {\n    background-color: rgba(0, 0, 0, 0.03);\n}\n\n.status-badge {\n    padding: 0.35em 0.65em;\n    font-size: 0.75em;\n    font-weight: 600;\n    border-radius: 0.375rem;\n    text-transform: uppercase;\n    letter-spacing: 0.05em;\n}\n\n.status-badge-success {\n    background-color: rgba(34, 197, 94, 0.1);\n    color: var(--success);\n}\n\n.status-badge-warning {\n    background-color: rgba(234, 179, 8, 0.1);\n    color: var(--warning);\n}\n\n.status-badge-danger {\n    background-color: rgba(239, 68, 68, 0.1);\n    color: var(--danger);\n}\n\n.status-badge-info {\n    background-color: rgba(14, 165, 233, 0.1);\n    color: var(--info);\n}\n\n.status-badge-secondary {\n    background-color: rgba(100, 116, 139, 0.1);\n    color: var(--secondary);\n}\n\n.form-control:focus, .form-select:focus {\n    border-color: var(--primary);\n    box-shadow: 0 0 0 0.25rem rgba(37, 99, 235, 0.25);\n}\n\n.btn-primary {\n    background-color: var(--primary);\n    border-color: var(--primary);\n}\n\n.btn-primary:hover {\n    background-color: #1d4ed8;\n    border-color: #1d4ed8;\n}\n\n.btn-outline-primary {\n    color: var(--primary);\n    border-color: var(--primary);\n}\n\n.btn-outline-primary:hover {\n    background-color: var(--primary);\n    border-color: var(--primary);\n}\n\n@media (max-width: 992px) {\n    .sidebar {\n        transform: translateX(-100%);\n    }\n    \n    .sidebar.show {\n        transform: translateX(0);\n    }\n    \n    .main-content {\n        margin-left: 0;\n    }\n    \n    .main-content.expanded {\n        margin-left: 0;\n    }\n}\n\n@media (max-width: 768px) {\n    .dash-cards {\n        flex-direction: column;\n    }\n    \n    .dash-card {\n        width: 100% !important;\n    }\n}\n","size_bytes":6648},"static/js/app.js":{"content":"// Global application state\nconst App = {\n    currentPage: 'dashboard',\n    sidebarCollapsed: false,\n    charts: {},\n    \n    // Initialize the application\n    init() {\n        this.setupEventListeners();\n        this.setupSidebar();\n        this.setupToasts();\n        this.setupDatePickers();\n        this.loadPage('dashboard');\n    },\n    \n    // Setup global event listeners\n    setupEventListeners() {\n        // Sidebar toggle\n        document.getElementById('toggleSidebar')?.addEventListener('click', () => {\n            this.toggleSidebar();\n        });\n        \n        // Sidebar navigation\n        document.querySelectorAll('.sidebar-item[data-page]').forEach(item => {\n            item.addEventListener('click', (e) => {\n                const page = e.currentTarget.dataset.page;\n                this.loadPage(page);\n            });\n        });\n        \n        // Form submissions\n        document.addEventListener('submit', (e) => {\n            if (e.target.matches('form[data-ajax]')) {\n                e.preventDefault();\n                this.handleFormSubmission(e.target);\n            }\n        });\n        \n        // Loading state management\n        document.addEventListener('fetch-start', () => {\n            this.showLoading();\n        });\n        \n        document.addEventListener('fetch-end', () => {\n            this.hideLoading();\n        });\n    },\n    \n    // Setup sidebar functionality\n    setupSidebar() {\n        const sidebar = document.getElementById('sidebar');\n        const mainContent = document.getElementById('mainContent');\n        \n        // Handle responsive sidebar\n        const handleResize = () => {\n            if (window.innerWidth <= 992) {\n                sidebar.classList.remove('sidebar-collapsed');\n                mainContent.classList.remove('expanded');\n            }\n        };\n        \n        window.addEventListener('resize', handleResize);\n        handleResize();\n    },\n    \n    // Toggle sidebar collapsed state\n    toggleSidebar() {\n        const sidebar = document.getElementById('sidebar');\n        const mainContent = document.getElementById('mainContent');\n        \n        if (window.innerWidth <= 992) {\n            // Mobile: show/hide sidebar\n            sidebar.classList.toggle('show');\n        } else {\n            // Desktop: collapse/expand\n            sidebar.classList.toggle('sidebar-collapsed');\n            mainContent.classList.toggle('expanded');\n            this.sidebarCollapsed = !this.sidebarCollapsed;\n        }\n    },\n    \n    // Setup toast notifications\n    setupToasts() {\n        const toasts = document.querySelectorAll('.toast');\n        toasts.forEach(toast => {\n            const bsToast = new bootstrap.Toast(toast, {\n                autohide: true,\n                delay: 5000\n            });\n            bsToast.show();\n        });\n    },\n    \n    // Setup date pickers\n    setupDatePickers() {\n        if (typeof flatpickr !== 'undefined') {\n            flatpickr('.date-picker', {\n                dateFormat: 'd/m/Y',\n                locale: 'pt'\n            });\n            \n            flatpickr('.datetime-picker', {\n                dateFormat: 'd/m/Y H:i',\n                enableTime: true,\n                locale: 'pt'\n            });\n        }\n    },\n    \n    // Load a specific page\n    loadPage(page) {\n        // Update sidebar active state\n        document.querySelectorAll('.sidebar-item').forEach(item => {\n            item.classList.remove('active');\n        });\n        \n        const activeItem = document.querySelector(`.sidebar-item[data-page=\"${page}\"]`);\n        if (activeItem) {\n            activeItem.classList.add('active');\n        }\n        \n        // Update page containers\n        document.querySelectorAll('.page-container').forEach(container => {\n            container.classList.remove('active');\n        });\n        \n        const pageContainer = document.getElementById(page);\n        if (pageContainer) {\n            pageContainer.classList.add('active');\n        }\n        \n        this.currentPage = page;\n        \n        // Load page-specific functionality\n        this.loadPageSpecific(page);\n    },\n    \n    // Load page-specific functionality\n    loadPageSpecific(page) {\n        switch (page) {\n            case 'dashboard':\n                this.loadDashboard();\n                break;\n            case 'products':\n                this.loadProducts();\n                break;\n            case 'sales':\n                this.loadSales();\n                break;\n            case 'customers':\n                this.loadCustomers();\n                break;\n            default:\n                break;\n        }\n    },\n    \n    // Dashboard specific functionality\n    loadDashboard() {\n        this.setPageTitle('Dashboard');\n        this.loadDashboardCharts();\n    },\n    \n    // Load dashboard charts\n    loadDashboardCharts() {\n        // Charts disabled - static dashboard mode\n        console.log('Charts disabled - using static dashboard mode');\n    },\n    \n    // Render sales chart\n    renderSalesChart(data) {\n        const ctx = document.getElementById('salesChart');\n        if (!ctx) return;\n        \n        // Destroy existing chart\n        if (this.charts.sales) {\n            this.charts.sales.destroy();\n        }\n        \n        this.charts.sales = new Chart(ctx.getContext('2d'), {\n            type: 'line',\n            data: {\n                labels: data.labels,\n                datasets: [{\n                    label: 'Vendas (€)',\n                    data: data.data,\n                    borderColor: '#2563eb',\n                    backgroundColor: 'rgba(37, 99, 235, 0.1)',\n                    tension: 0.4,\n                    fill: true\n                }]\n            },\n            options: {\n                responsive: true,\n                maintainAspectRatio: false,\n                plugins: {\n                    legend: {\n                        display: false\n                    }\n                },\n                scales: {\n                    y: {\n                        beginAtZero: true,\n                        ticks: {\n                            callback: function(value) {\n                                return App.formatCurrency(value);\n                            }\n                        }\n                    }\n                }\n            }\n        });\n    },\n    \n    // Render products chart\n    renderProductsChart(data) {\n        const ctx = document.getElementById('productsChart');\n        if (!ctx) return;\n        \n        // Destroy existing chart\n        if (this.charts.products) {\n            this.charts.products.destroy();\n        }\n        \n        this.charts.products = new Chart(ctx.getContext('2d'), {\n            type: 'doughnut',\n            data: {\n                labels: data.labels,\n                datasets: [{\n                    data: data.revenues,\n                    backgroundColor: [\n                        '#2563eb',\n                        '#22c55e',\n                        '#eab308',\n                        '#ef4444',\n                        '#0ea5e9'\n                    ]\n                }]\n            },\n            options: {\n                responsive: true,\n                maintainAspectRatio: false,\n                plugins: {\n                    legend: {\n                        position: 'bottom'\n                    },\n                    tooltip: {\n                        callbacks: {\n                            label: function(context) {\n                                return context.label + ': ' + App.formatCurrency(context.raw);\n                            }\n                        }\n                    }\n                }\n            }\n        });\n    },\n    \n    // Handle AJAX form submissions\n    handleFormSubmission(form) {\n        const formData = new FormData(form);\n        const url = form.action || window.location.href;\n        const method = form.method || 'POST';\n        \n        this.showLoading();\n        \n        fetch(url, {\n            method: method,\n            body: formData\n        })\n        .then(response => response.json())\n        .then(data => {\n            if (data.success) {\n                this.showToast(data.message || 'Operação realizada com sucesso!', 'success');\n                if (data.redirect) {\n                    window.location.href = data.redirect;\n                } else {\n                    this.refreshCurrentPage();\n                }\n            } else {\n                this.showToast(data.message || 'Erro ao processar solicitação', 'error');\n            }\n        })\n        .catch(error => {\n            console.error('Form submission error:', error);\n            this.showToast('Erro ao processar solicitação', 'error');\n        })\n        .finally(() => {\n            this.hideLoading();\n        });\n    },\n    \n    // Show loading indicator\n    showLoading() {\n        const loading = document.querySelector('.loading');\n        if (loading) {\n            loading.classList.add('active');\n        }\n    },\n    \n    // Hide loading indicator\n    hideLoading() {\n        const loading = document.querySelector('.loading');\n        if (loading) {\n            loading.classList.remove('active');\n        }\n    },\n    \n    // Show toast notification\n    showToast(message, type = 'info') {\n        const toastContainer = document.querySelector('.toast-container');\n        if (!toastContainer) return;\n        \n        const toastHtml = `\n            <div class=\"toast\" role=\"alert\" aria-live=\"assertive\" aria-atomic=\"true\">\n                <div class=\"toast-header\">\n                    <i class=\"fas fa-${this.getToastIcon(type)} text-${type} me-2\"></i>\n                    <strong class=\"me-auto\">GestVendas</strong>\n                    <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"toast\"></button>\n                </div>\n                <div class=\"toast-body\">${message}</div>\n            </div>\n        `;\n        \n        toastContainer.insertAdjacentHTML('beforeend', toastHtml);\n        \n        const newToast = toastContainer.lastElementChild;\n        const bsToast = new bootstrap.Toast(newToast, {\n            autohide: true,\n            delay: 5000\n        });\n        bsToast.show();\n        \n        // Remove toast after it's hidden\n        newToast.addEventListener('hidden.bs.toast', () => {\n            newToast.remove();\n        });\n    },\n    \n    // Get appropriate icon for toast type\n    getToastIcon(type) {\n        const icons = {\n            'success': 'check-circle',\n            'error': 'times-circle',\n            'warning': 'exclamation-triangle',\n            'info': 'info-circle'\n        };\n        return icons[type] || 'info-circle';\n    },\n    \n    // Format currency values\n    formatCurrency(value) {\n        return new Intl.NumberFormat('pt-PT', {\n            style: 'currency',\n            currency: 'EUR'\n        }).format(value);\n    },\n    \n    // Set page title\n    setPageTitle(title) {\n        document.title = `${title} - GestVendas`;\n    },\n    \n    // Refresh current page\n    refreshCurrentPage() {\n        this.loadPageSpecific(this.currentPage);\n    },\n    \n    // Initialize DataTables\n    initDataTables(selector, options = {}) {\n        if (typeof $ !== 'undefined' && $.fn.DataTable) {\n            const defaultOptions = {\n                language: {\n                    url: '//cdn.datatables.net/plug-ins/1.13.5/i18n/pt-PT.json'\n                },\n                responsive: true,\n                pageLength: 25,\n                order: [[0, 'desc']]\n            };\n            \n            return $(selector).DataTable({...defaultOptions, ...options});\n        }\n    },\n    \n    // Product search functionality\n    setupProductSearch() {\n        const searchInput = document.getElementById('productSearch');\n        if (!searchInput) return;\n        \n        let searchTimeout;\n        \n        searchInput.addEventListener('input', (e) => {\n            clearTimeout(searchTimeout);\n            searchTimeout = setTimeout(() => {\n                this.searchProducts(e.target.value);\n            }, 300);\n        });\n    },\n    \n    // Search products via API\n    searchProducts(query) {\n        if (query.length < 2) return;\n        \n        fetch(`/api/products/search?q=${encodeURIComponent(query)}`)\n            .then(response => response.json())\n            .then(products => {\n                this.displayProductSearchResults(products);\n            })\n            .catch(error => {\n                console.error('Product search error:', error);\n            });\n    },\n    \n    // Display product search results\n    displayProductSearchResults(products) {\n        const resultsContainer = document.getElementById('productSearchResults');\n        if (!resultsContainer) return;\n        \n        if (products.length === 0) {\n            resultsContainer.innerHTML = '<p class=\"text-muted\">Nenhum produto encontrado</p>';\n            return;\n        }\n        \n        const resultsHtml = products.map(product => `\n            <div class=\"product-result\" data-product-id=\"${product.id}\">\n                <div class=\"d-flex justify-content-between align-items-center\">\n                    <div>\n                        <strong>${product.name}</strong>\n                        <br>\n                        <small class=\"text-muted\">Código: ${product.code}</small>\n                    </div>\n                    <div class=\"text-end\">\n                        <div class=\"fw-bold\">${this.formatCurrency(product.sale_price)}</div>\n                        <small class=\"text-muted\">Stock: ${product.stock_quantity} ${product.unit}</small>\n                    </div>\n                </div>\n            </div>\n        `).join('');\n        \n        resultsContainer.innerHTML = resultsHtml;\n        \n        // Add click handlers for product results\n        resultsContainer.querySelectorAll('.product-result').forEach(result => {\n            result.addEventListener('click', (e) => {\n                const productId = e.currentTarget.dataset.productId;\n                this.selectProduct(productId, products);\n            });\n        });\n    },\n    \n    // Select a product from search results\n    selectProduct(productId, products) {\n        const product = products.find(p => p.id == productId);\n        if (!product) return;\n        \n        // Trigger custom event for product selection\n        document.dispatchEvent(new CustomEvent('productSelected', {\n            detail: product\n        }));\n    }\n};\n\n// Initialize the application when DOM is loaded\ndocument.addEventListener('DOMContentLoaded', function() {\n    App.init();\n});\n\n// Global utility functions\nwindow.formatCurrency = App.formatCurrency.bind(App);\nwindow.showToast = App.showToast.bind(App);\nwindow.showLoading = App.showLoading.bind(App);\nwindow.hideLoading = App.hideLoading.bind(App);\n","size_bytes":14850}},"version":1}